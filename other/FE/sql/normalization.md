# 正規化

正規化とは、データが重複したり、データ更新の際に矛盾が生じないようにテーブルを分けること。

表中のすべての`関数従属`から、`部分関数従属`と`推移的関数従属`を取り除き、`完全関数従属`だけを残すこと。

## 従属

ある属性(列)が決まると、他の属性(列)の値も一意に決まること。

- 完全関数従属 : 属性が主キーに関数従属すること
- 部分関数従属 : 属性が主キーの一部に関数従属すること(主キーが複合主キーの場合、その一部)
- 推移的関数従属 : 属性が主キー以外の属性に関数従属すること

## 第1正規化

属性の繰り返しがない状態にすること。

非正規化のテーブルを第1正規化するにはレコードを追加する。

### 正規化前

| 動物ID | 名前       | 種類   | 飼い主 | 飼い主住所   | 診察日     | 症状         | 診察日     | 症状 |
|--------|------------|--------|--------|--------------|------------|--------------|------------|------|
| 1      | じょん     | いぬ   | 勇者   | 京都市下京区 | 2025-07-07 | 食欲がない   | 2025-06-30 | 下痢 |
| 2      | ぴょんきち | うさぎ | 魔人   | 大阪市北区   | 2025-06-30 | 咳をしている |            |      |

- 診察日・症状が2つずつある => 属性が繰り返しがある状態

### 第1正規化後のテーブル(属性に繰り返しがない)

| 動物ID | 名前       | 種類   | 飼い主 | 飼い主住所   | 診察日     | 症状         |
|--------|------------|--------|--------|--------------|------------|--------------|
| 1      | じょん     | いぬ   | 勇者   | 京都市下京区 | 2025-07-07 | 食欲がない   |
| 2      | ぴょんきち | うさぎ | 魔人   | 大阪市北区   | 2025-06-30 | 咳をしている |
| 1      | じょん     | いぬ   | 勇者   | 京都市下京区 | 2025-07-08 | 下痢         |

残る問題点:

- 同じ動物の情報が何度も出てくる(データの重複)
- 飼い主情報、診察情報が1つの表に混在している
- 更新・削除・挿入で不整合が起きやすい

このテーブルで主キーは、動物IDと診察日の複合主キーだと考えられる。

- 名前・種類・飼い主・飼い主住所は診察日がなくても動物IDで一意に決まる => 部分関数従属になっている

## 第2正規化

部分関数従属がない状態にすること。

第1正規形から第2正規形にするには、テーブルを分割する。

### 2つのテーブルに分ける

動物テーブル(動物の基本情報)

| 動物ID | 名前       | 種類   | 飼い主 | 飼い主住所   |
|--------|------------|--------|--------|--------------|
| 1      | じょん     | いぬ   | 勇者   | 京都市下京区 |
| 2      | ぴょんきち | うさぎ | 魔人   | 大阪市北区   |

診察テーブル(診察の情報)

| 動物ID | 診察日     | 症状         |
|--------|------------|--------------|
| 1      | 2025-07-07 | 食欲がない   |
| 2      | 2025-06-30 | 咳をしている |
| 1      | 2025-07-07 | 下痢         |

これで部分的関数従属がなくなったので、第2正規化はクリア。

動物テーブルでは動物IDによって、名前・種類・飼い主が一意に決まる(完全関数従属)が、飼い主住所は飼い主によって決まる(推移的関数従属)

=> `動物ID => 飼い主 => 飼い主住所` : これが推移的関数従属  

動物テーブルは、動物IDと診察日の複合主キーに症状が完全関数従属しているのでオッケー(とりあえずは)。

## 第3正規化

推移的関数従属がない状態にする。

第2正規形のテーブルをさらに分割して、推移的関数従属をなくす。

### 動物テーブルをさらに分割

動物テーブル : 変更

| 動物ID | 名前       | 種類   | 飼い主ID |
|--------|------------|--------|----------|
| 1      | じょん     | いぬ   | 1        |
| 2      | ぴょんきち | うさぎ | 2        |

飼い主テーブル(飼い主の情報) : 追加

| 飼い主ID | 名前 | 住所         |
|----------|------|--------------|
| 1        | 勇者 | 京都市下京区 |
| 2        | 魔人 | 大阪市北区   |

診察テーブル : 変更なし

| 動物ID | 診察日     | 症状         |
|--------|------------|--------------|
| 1      | 2025-07-07 | 食欲がない   |
| 2      | 2025-06-30 | 咳をしている |
| 1      | 2025-07-07 | 下痢         |

これで第3正規化までできた :dog:

今回の例では、これで第3正規化までできたが、診察テーブルにおいては同じ動物IDが同じ日に違う症状で2回以上受信する可能性もある。

そうなると動物IDと診察日だけでは一意にデータを特定することができないので、診察IDや回数などの属性を追加した方がいい :dog:

## 第3正規化までまとめ

| 正規化    | 意味                                 | 何をなくす？                   |
|-----------|--------------------------------------|--------------------------------|
| 第1正規化 | 繰り返しの排除                       | 繰り返し属性(同じ列に複数の値) |
| 第2正規化 | 主キーの一部だけに依存する属性を分離 | 部分関数従属                   |
| 第3正規化 | 非キー属性同士の依存を分離           | 推移的関数従属                 |

