# gpg

GnuPG(GNU Privacy Guard)は暗号化プログラム。

公開鍵暗号方式にも対応している。

ファイルの暗号化や復号を行うには`gpg`コマンドを使用する。

### オプション

| オプション  | 説明                                                       |
|-------------|------------------------------------------------------------|
| --gen-key   | 公開鍵暗号方式の鍵ペアを生成                               |
| --export    | 公開鍵をエクスポート                                       |
| --import    | 公開鍵をインポート                                         |
| --list-keys | 公開鍵を一覧表示                                           |
| --sign      | ファイルに署名                                             |
| --verify    | ファイルの署名を検証                                       |
| -e          | 暗号化データを受け取る側の公開鍵を使用してファイルを暗号化 |
| -o          | 出力ファイル名を指定                                       |
| -r          | 暗号化に使用する公開鍵の持ち主のメールアドレスを指定       |

## 公開鍵暗号方式の鍵ペアを作成

暗号化データを受け取る側で、公開鍵と秘密鍵の鍵ペアを作成する。

他社に公開できる公開鍵で暗号化されたファイルは、その公開鍵のペアとなる秘密鍵でしか復号できない。

そのため、秘密鍵は作成したユーザーのみが管理し、他社に漏れないようにする。

- `gpg --gen-key`実行時にパスフレーズを入力するダイアログを表示させるために、`pinentry-curses`(パスフレーズ入力ダイアログのコレクション)をインストールしておく必要あり
- `gpg-agnet`というデーモンプログラムが、秘密鍵を管理し、パスフレーズによる認証状態を一定期間キャッシュする

## 公開鍵のエクスポート

暗号化に使用する公開鍵を通信相手に渡すため、公開鍵をファイルに出力する。

- server-dのユーザーjohnが暗号化データを受け取る側
- server-pのユーザーpyonkichiが暗号化データを送る側

server-dのjohnで鍵ペアを作成:

```
gpg --gen-key

# ~/.gnupg ディレクトリが作成される
# 鍵の種類を選択する(デフォルトはRSA)
# 鍵の長さを1024～4096間で指定
# 鍵の有効期限を指定(0は無期限)
# ユーザーIDを構成(本名とメールアドレスを入力) ここでは本名: john / メールアドレス: john@doogle.com とする
# 別画面でパスフレーズを入力
```

john@doogle.comを用いる公開鍵をpubkeyというファイル名でエクスポート:

```
gpg -o pubkey` --export john@doogle.com
```

エクスポートされたpubkeyファイルを暗号化データを送る側に送る:

```
# リモートホストのserver-pにユーザーpyonkichiとしてログインして公開鍵ファイルをコピー
scp pubkey pyonkichi@server-p:~/pubkey
```

## 公開鍵のインポート

暗号化データを送る側(server-pのpyonkichi)でエクスポートされた公開鍵をインポート:

```
pgp --import pubkey
```

## インポートした公開鍵を使用しファイルを暗号化

```
# dog.txtを暗号化する
gpg -e -r john@doogle.com dog.txt
```

dog.txtを暗号化した`dog.txt.gpg`ファイルが作成される。

=> 暗号化されているのでcatとかで中身を見ることができない

### 暗号化したファイルをデータ受け取り側(john)に送っておく

`scp dog.txt.gpg john@server-d:~/dog.txt.gpg`

## ファイルの復号

暗号化データを受け取る側で、送られてきた暗号化ファイルを自分の秘密鍵を使って復号する:

```
gpg dog.txt.gpg

# 別画面でパスフレーズを入力
# 復号されたファイル、dog.txtが作成される
```

## ファイルの署名

秘密鍵を使用してファイルに署名することで、ファイルの作成者が本人かどうかやファイルが改ざんされていないかを確認できる。

dog2.txtファイルに署名:

```
gpg --sign dog2.txt # => dog2.txt.gpgファイルが作成される
```

署名を検証:

```
gpg --verify dog2.txt.gpg
```

