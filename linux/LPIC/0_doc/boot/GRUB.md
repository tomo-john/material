# GRUB / GRUB2

GRUB(GRand Unified Bootloader)とGTUB2はLinuxを起動するためのブートローダ。

ブートローダはBIOS/UEFIによって起動され、最終的にOSのカーネルを読込んで起動する役割を持っている。

- OS選択: 複数のOSがインストールされている場合、どれを起動するか選択
- カーネルロード: 選択されたOSのカーネルをメモリにロード
- 初期RAMディスクのロード(initramfs): カーネルが利用する必要なドライバやモジュールを提供
- 制御の移譲: カーネルに制御を渡して、ブートローダの役割を終える

## GRUB(GRUB Legacy) ver0.9x

GRUBの設定ファイルは`/boot/grub/menu.lst` => 手動で編集が可能。変更後は即座に反映。

ディストリビューションによっては`/boot/grub/grub.conf`の場合もあり。

システムを起動しブートローダがカーネルをロードする際、ブートローダの設定ファイルに記載されていないオプションを、起動オプションとして起動プロンプトで指定が可能。

```
grub> kernel カーネルイメージ [オプション]
```

| 起動オプション  | 説明                                     |
|-----------------|------------------------------------------|
| init=パス       | initの代わりに指定コマンドを実行         |
| root=デバイス名 | ルートパーティションを指定               |
| 数字(0-6)       | 指定したランレベルで起動                 |
| quiet           | 起動中のカーネルからの情報出力を抑制する |

```
# メンテナンス用にシングルユーザーモードで起動
grub> kernel /boot/vmlinuz-2.6.35 1
```

=> 数字の1は`s`, `single`を指定してもシングルユーザーモードで起動が可能

## GRUB2 ver1.9x以降

GRUB2の設定ファイルは`/boot/grub/grub.cfg` => このファイルを直接編集することはない。

設定内容は`/etc/default/grub`ファイルおよび`/etc/grub.d`ディレクトリ内のファイルに記述し、`grub-mkconfig`コマンドで設定内容を`/boot/grub/grub.cfg`ファイルに反映させる。

## どこにいる(BIOSの場合)

ブートローダはMBR(Master Boot Record)に格納されている第一段階部分と、記憶装置内の別の場所に格納されている第二段階部分がある。

MBRはディスクの先頭`512バイト`だけの非常に小さな領域 => この中でブートローダに使えるのは最初の`446バイト`。

残りはパーティション情報(`16バイト`が4つ)とブートシグネチャ(`2バイト`)が入っている。

- 1: 第一段階(Stage1) : MBRの先頭446バイトに収まる最小限のコード

  => 次のステージ(Stage1.5またはStage2)をロードする

- 2: 第二段階(Stage2) : MBR以外の場所(たとえば`/boot/grub`とか)

  => GRUBメニューやファイルシステムアクセスなどを扱う本体

## MBRの構成

先頭から:

- 446B : ブートストラップローダ(最小のコード:次のブートローダを読込む)
- 16B : パーティション1情報
- 16B : パーティション2情報
- 16B : パーティション3情報
- 16B : パーティション4情報
- 2B : ブートシグネチャ : 値は常に`0x55AA`(BIOSがMBRと認識するために必要)

パーティション情報には、パーティションの開始位置、サイズ、ファイルシステムの種類、起動フラグなどが入っている。

=> これはOSのブートだけでなく、ディスク管理にとっても重要な情報

`fdisk`や`parted`などでパーティションの追加や変更をするとMBRのパーティションテーブル(合計64バイト)が書き換えれる。

MBRに記録できるのは最大4個までのプライマリパーティション(その制限もMBRの古さの一因)。


## どこにいる2(GTPの場合)

最近のLinux(UEFI環境)では`GPT(GUID Partition Table)`がMBRの代わりに使用されることが多い。

| 項目                 | MBR                   | GPT                              |
|----------------------|-----------------------|----------------------------------|
| 最大パーティション数 | 基本4つ(拡張で増やす) | ほぼ無制限(128個など)            |
| 起動方式             | BIOS                  | UEFI                             |
| ブートローダ格納場所 | MBR(先頭446B)         | EFIシステムパーティション(FAT32) |

- 通常`/boot/efi`にマウントされている
- ブートローダは`.efi`形式(UEFIが直接読込む)
- MBRのような446バイトの第一段階みたいな制約がない

