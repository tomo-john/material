# ファイルシステム

## ファイルシステムを使用するまでの流れ

### 1 ディスクのパーティション分割

ディスクに新しいファイルシステムを作成するためには、まずパーティションを分割する

=> `fdisk`, `gdisk`, `parted`コマンドを使用

fdiskコマンド例:

```
sudo fdisk /dev/sdx # sdxは対象デバイス(例: sda, sdbなど)
```

=> `n`コマンドで新しいパーティションを作成し、`w`コマンドで変更を保存

### 2 ファイルシステムの作成

パーティションができたら、`mkfs`コマンドを使ってファイルシステムを作成する

ext4ファイルシステム作成例:

```
sudo mkfs -t ext4 /dev/sdx1

# 以下も同じ

sudo mkfs.ext4 /dev/sdx1
```

Linuxでの主なフィアルシステム:

- `ext4`: Linuxで一般的なファイルシステム
- `XFS`: 大規模データに適したファイルシステム
- `Btrfs`: スナップショット機能などが豊富

### 3 スワップ領域の作成(任意)

スワップ領域が必要な場合は、`mkswap`コマンドでスワップ用のファイルシステムを作成

スワップ領域の作成例:

```
sudo mkswap /dev/sdx2 # sdx2はスワップ用パーティション
sudo swapon /dev/sdx2 # スワップを有効化
```

### 4 マウントポイントの作成

ファイルシステムをマウントする場所(ディレクトリ)を作成 => マウントポイントがすでにあれば不要

### 5 ファイルシステムのマウント

`mount`コマンドでファイルシステムを指定のディレクトリにマウント

マウント例:

```
sudo mount /dev/sdx1 /mnt/data
```

### 6 自動マウント設定(/etc/fstab)

再起動後も自動的にマウントするため、`/etc/fstab`にエントリを追加

/etc/fstabへの設定例:

```
/dev/sdx1 /mnt/data ext4 defaults 0 2
```

### 7 ファイルシステムの利用

マウントが完了したら、通常のディレクト同じように扱うことが可能

### 8 マウントの解除(アンマウント)

ファイルシステムの利用が終わったら`umount`コマンドでアンマウント

アンマウント例:

```
sudo umount /mnt/data
```

### 関連コマンド

- `fdisk`: パーティション作成(変更・削除)、主に`MBR`パーティションテーブルを扱う
- `gdisk`: パーティション作成(変更・削除)、主に`GPT`パーティションテーブルを扱う
- `parted`: MBRもGPTも扱うことができるパーティション管理コマンド

- `mkfs`: ファイルシステムの作成、各ファイルシステムの種類に対応したプログラムのフロントエンド
- `mke2fs`: ext2, ext3, ext4を作成する際に使用できるコマンド
- `mkswap`: スワップ領域の作成
- `swapon`: スワップの有効化

- `mount`: ファイルシステムのマウント
- `umount`: ファイルシステムの解除(アンマウント)

### 関連ファイル

- `/etc/fstab`: 自動的にマウントするためのエントリを追加するファイル

  左から 

  1: ファイルシステム: マウントするディスクデバイスのパス(`/dev/sda1`や`UUID=xxxxx`)

  2: マウントポイント: マウントするディレクトリ(`/mdedia`, `/mnt`など)

  3: ファイルシステムの種類: ファイルシステムタイプ(`ext4`, `xfs`, `swap`など)

  4: オプション: 読み書き設定や自動マウントの有無など(`default`, `ro`など)

  5: ダンプ: dumpコマンドでバックアップするかしないか => 0: バックアップなし, 1: バックアップあり

  6: fsckオプション: ファイルシステムの順序 => 0: チェックなし, 1, 2 ...: 優先順位(ルートファイルシステムは`1`、他は`2`)

  システム起動時に読込まれ、設定内容の沿ってマウントされる

  `mount -a`で/etc/fstabの記載内容を手動マウントも可能(noautoオプションは除外、-tでマウントするファイルシステムタイプの制限可能)

- `/etc/mtab`: 現在マウント中のファイルシステム

  現在システムにマウントされているファイル情報を記録するファイル

  `mount`コマンドで手動でマウントしたものや、`/etc/fstab`で自動マウントされたものが記録される

  マウント、アンマウントするたびに自動的に内容が変わり、手動で操作・編集はしない

  `mount`コマンドをオプションなしで使用した時と同様にどのディレクトリにどのファイルシステムがマウントされているかわかる

  最近は`/proc/mounts`が同様の役割を果たしており、`/etc/mtab`は`/proc/mounts`のシンボリックリンクとされていることもある


