# Linuxもおける時刻関連

| 種別                 | コマンド | 内容                                                                  |
|----------------------|----------|-----------------------------------------------------------------------|
| ハードウェアクロック | hwclock  | コンピューターに内蔵された時刻。電源OFFでも動作                       |
| システムクロック     | date     | Linuxカーネルが持つ時刻。システム起動時にハードウェアクロック値が設定 |

### hwclock

オプションなし(または`-r`)でハードウェアクロックを表示する。

| オプション    | 内容 |
|---------------|------|
| -r            | ハードウェアクロックを表示(オプションなしと同じ)   |
| -s(--hctosys) | ハードウェアクロックの時刻をシステムクロックに反映 |
| -w(--systohc) | システムクロックの時刻をハードウェアクロックに反映 |

### date

オプションや引数なしで実行すると、現在のにづけ時刻が表示される。

日付時刻変更の書式: `date [MMDDhhmm[[CC]YY][.ss]]`

=> MM: 月, DD: 日, hh: 時, mm: 分, CC: 西暦上2桁, YY: 西暦下2桁, ss: 秒


# NTP

Network Time Protocolはネットワーク経由で正確なクロックを同期(時刻同期)するプロトコル。

時刻同期には認知のタイミングでNTPサーバーから時刻を取得する方法と、NTPデーモン(`ntpd`)により自動え時刻を同期する方法がある。

NTPはUDPポートの`123番`を送受信に使って通信を行う。

- ntpdate : 指定したNTPサーバーから現在時刻を取得するコマンド
- ntpq : NTPサーバーの状態を照会することができるコマンド

## ntpdate

NTPサーバーからシステムクロックへ時刻を同期する。

=> ハードウェアクロックに反映させる場合は`hwclock -w(--systohc)`

書式: ntpdate [オプション] NTPサーバー

```
ntpdate pool.ntp.org
```

## ntpd

NTPデーモン。指定したNTPサーバーに定期的に時刻情報を問い合わせて自身の時刻を修正し、正確なシステムクロックを維持する。

ntpdの各種設定は`/etc/ntp.conf`で行う。

| 設定項目  | 説明                                         |
|-----------|----------------------------------------------|
| restrict  | ntpdへのアクセス制限を行う                   |
| server    | 時刻を取得するサーバーを指定                 |
| driftfile | 自身の時刻のズレ具合を記録するファイルを指定 |

## ntpq

ntpdの時刻同期状況を確認できるコマンド。

デフォルトでは対話モード(-iオプションと同じ)で起動する。

| オプション | 説明                                                                              |
|------------|-----------------------------------------------------------------------------------|
| -p         | serverに指定したサーバーとの同期状態を一覧表示(対話モードの`peers`コマンドと同じ) |
| -i         | 対話モードで起動する(デフォルト)                                                  |

`ntpq -p`で表示される項目:

| 項目   | 説明                                                                                                             |
|--------|------------------------------------------------------------------------------------------------------------------|
| remote | serverに指定したNTPサーバーのホスト。先頭に`*`が付いているものが時刻同期先。`+`は時刻同期可能。`-`は参照しない。 |
| refid  | remoteのサーバーの時刻参照先アドレス。同期開始時は`.INIT.`、stratum 1サーバーでは`.GPS.`などを表示               |
| st     | remoteのサーバーのstratum                                                                                        |

# Chrony

Chrony(クローニー)はntpdに代わるNTPサーバー/クライアント。

- chronyd : Chronyのデーモン
- chronyc : chronydのコマンドラインツールコマンド

chronydはntpdに比べ、ネットワークの混雑が続いたり通信が不安定な状態でも良好に動作し、高い制度で時刻を同期することができる。

必要な時だけCPUを使用し、メモリの使用量も少なく、RHEL7やCentOS7以降では標準の時刻同期システムとなっている。

Chronyの設定ファイルは`/etc/chrony.conf`

| 設定項目  | 説明 |
|-----------|---------------------------------------------------------------------|
| server    | 時刻を取得するNTPサーバーを指定(サーバー/クライアントの関係)        |
| peer      | 時刻を取得するNTPサーバーを指定(同じstratum同士)                    |
| pool      | 時刻を取得するNTPサーバーのプール(複数アドレスを集約した名前)を指定 |
| driftfile | 自身の時刻のズレ具合を記録するファイルを指定                        |
| rtcsync   | システムクロックをハードウェアクロック(RTC)にコピーする             |

設定項目のserverの最後に`ibrust`がある場合は、起動直後にNTPサーバーに対して短い間隔で4回問い合わせることで時刻同期を速めるオプション。

### chronyc

chronydの管理を行うコマンド。

書式: `chronyc [サブコマンド]`

=> サブコマンドを指定せずにchronycを実行すると対話モードで起動する

| サブコマンド | 説明                                       |
|--------------|--------------------------------------------|
| activity     | オンライン/オフラインのNTPサーバー数を表示 |
| sources      | 時刻のソースを表示                         |
| sourcestats  | 時刻のソースの統計情報を表示               |
| tracking     | トラッキング(時刻同期の詳細情報)を表示     |

# timesatectl

systemdの動作するシステムにおいてシステム時刻の表示や設定を行うコマンド。

=> システムクロックとハードウェアクロックを同時に設定できる

書式: `timedatectl [サブコマンド]`

=> サブコマンドを指定せずに実行すると、現在の日付時刻が表示される(statusサブコマンドと同じ)

| サブコマンド              | 説明                                                    |
|---------------------------|---------------------------------------------------------|
| status                    | 現在の日付時刻や状態の表示(デフォルト)                  |
| set-ntp yes/no            | NTPによる時刻同期の有効/無効                            |
| set-time 日付や時刻       | 日付や時刻の設定(時刻を設定しない場合は0時0分0秒になる) |
| set-timezone タイムゾーン | タイムゾーンの設定                                      |
| list-timezones            | タイムゾーンの一覧表示                                  |

=> `set-time`の書式は`YYYY-MM-DD hh:mm:ss`

=> `set-time`で手動設定する場合はNTPを無効にしておく必要あり(`set-ntp no`)

