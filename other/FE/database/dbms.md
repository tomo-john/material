# DBMS(RDBMS)

DBMS(DataBase Management System) : データベース管理システムはアプリケーションソフトウェアの要求に応じてデータベースを操作するシステム。

=> アプリケーションソフトウェアが直接データベースを操作することは基本的にない

データベース管理システムの主な3つの機能:

- データ操作([sql.md](sql.md))
- トランザクション管理
- 排他制御

## トランザクション管理

トランザクションとは関連する複数の処理のかたまり。

トランザクション管理ではユーザーがDBMSに対して行う一連のトランザクションを管理する。

## ACID特性

トランザクション管理に必要な4つの性質の頭文字をとった造語。

| 性質                | 説明                                                                                     |
|---------------------|------------------------------------------------------------------------------------------|
| 原子性(Atomicity)   | トランザクション内の処理がすべて実効されるか、すべて取り消されるかのどちらか             |
| 一貫性(Consistency) | トランザクションの前後でデータベースに矛盾がない                                         |
| 独立性(Isolation)   | 1つのトランザクションの処理結果が、他のトランザクションの処理の影響を受けない            |
| 耐久性(Durability)  | トランザクション完了後にハードウェア障害が発生しても、更新されたデータベースの内容は保証 |

## 障害回復

壊れたデータやハードウェアを直すこと。

=> リカバリとも呼ばれる

データベースの障害回復のためには`バックアップファイル`と`ログファイル`の2つが必要。

- バックアップファイル : データベース全体を保存しているファイル(定期的にバックアップする)
- ログファイル : トランザクションの前後の状態を保存したファイル(更新前ログファイルと更新後ログファイル)

バックアップファイルやログファイルを使った障害回復の方法には、`ロールバック`と`ロールフォワード`の2種類がある。

### ロールバック 

トランザクション実行中に障害が発生した際に、データベースをトランザクション開始直前の状態に戻す。

=> 更新前ログファイルを使ってデータベースを復元する

### ロールフォワード

データベースをトランザクション完了直後の状態に戻す。

=> バックアップファイルと更新後ログファイルを使ってデータベースを復元する

## 排他制御

排他制御とは、複数人が同じデータを同時に更新しようとした場合にデータに矛盾が生じないようにする機能。

=> データの一貫性を保つ

`ロック`によりデータベースの読み書きを一時的に制限する。

=> ロックには`専有ロック`と`共有ロック`の2種類が存在する

`専有ロック`ではロックをかけたトランザクションのみがデータを読み書きできるロック。

=> データベースを更新する際に使われる

`共有ロック`はロックをかけたトランザクションと他のトランザクションの両方が、データの読み出しのみは行えるロック。

=> どちらのトランザクションも書き込みはできない

=> データを読みだすことが目的の場合は、共有ロックを行う

共有ロックがかかっているデータに対して、他のトランザクションから共有ロックをかけることは可能。

共有ロックがかかっているデータに対して、専有ロックをかけることはできない。

専有ロックがかかっているデータに対して、他のトランザクションから共有ロックも専有ロックもかけることができない。

| ロック | 共有 | 専有 |
|--------|------|------|
| 共有   | OK   | NG   |
| 専有   | NG   | NG   |

## デッドロック

複数のトランザクションが、お互いに相手が専有ロックしている資源を要求して待ち状態となり、実行できなくなる状態。

相手のロックが解放されるまで、お互いに永遠に待ち状態に陥ってしまう。

- トランザクション1 : データAを専有ロック
- トランザクション2 : データBを専有ロック
- トランザクション1 : データBを共有ロック(ロック解除待ち)
- トランザクション2 : データAを専有ロック(ロック解除待ち) <= デッドロック発生

デッドロックはお互いのロック解除待ちの状態。

### デッドロックの解除方法

- 1. トランザクションの強制終了(ロールバック)
  - DBMSは通常デッドロック検出機能を持っていて、検知するとどちらのトランザクションを強制終了してロールバックさせる
  - リソースが解放されて、もう片方が進めるようになる

- 2. タイムアウト方式
  - 一定時間ロックを待っても取得できなければ、自動的にロールバックする

## 媒体障害

データベースを格納している記憶媒体(ディスク、SSDなど)そのものが壊れる障害のこと。

- ハードディスクが物理的に故障してデータが読めなくなる
- 記憶領域の一部が破損してしまう
- RAIDのドライブがクラッシュ

=> データファイル自体が使えなくなるタイプの障害

バックアップファイルとログファイルを利用して障害発生直前までの更新を再現する。(`ロールフォワード`)

