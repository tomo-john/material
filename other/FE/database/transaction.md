# トランザクション

## 2相コミット

Two Phase Commit

トランザクションのコミットを次の2つの段階に分けて行うことで、分散データベース環境での原子性・一貫性を保証する仕組み。

- 第1フェーズ: 他サイトに更新可能かどうかを確認する。
- 第2フェーズ: 全サイトからの合意が得られた場合に更新を確定する。

コミットの調整を行う1つのノードを`調停者(主サイト)`、ネットワーク上の他のノードを`参加者(従サイト)`として以下の手順を実施。

### 第1相(投票層)

- 1. 主サイトはネットワーク上の全ての従サイトにコミットの可否を問合せ
- 2. 全ての従サイトは主サイトにコミットの可否を応答

### 第2相(決定層)

- 3. 全ての従サイトから合意 => 全ての従サイトにコミットの実行要求を発光

  => コミット停止の従サイトあり or タイムアウト => 全ての従サイトにロールバック要求

- 4. 全ての従サイトはコミット(またはロールバック)の完了とともに主サイトに処理完了メッセージ送る
- 5. 主サイトが全ての従サイトからの処理完了メッセージを受け取り、トランザクションの完了

