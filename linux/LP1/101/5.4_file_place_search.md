# ファイルの配置と検索

## 1 FHS

Linuxにおけるファイルシステム内のレイアウトは、ファイルシステム階層標準として標準化が進められている

=> ファイルシステム標準階層: `FHS(Filesystem Hierarchy Standard)`

主要なディストリビューションはFHSをサポートしている

ルートファイルシステムはLinuxのディレクトリ階層の中で最上位に位置する

=> ルートファイルシステムに含まなければならないディレクトリ: `/bin`, `/sbin`, `/etc`, `/dev`, `/lib`

### /bin

基本的なコマンドが配置される(一般ユーザーでも実行が可能なコマンド)

cat, chgrp, chmod, chown, cp, date, dd, df, dmesg, echo, hostname, kill, ln, login, ls,

mkdir, more, mount, mv, ps, pwd, rm, rmdir, sed, sh, su, sync, umount, unameなどが規定されている

### /sbin

システム管理に必須のコマンドが配置される(rootユーザーのみが実行可能なコマンド)

shutdown, fdisk, fsck, ifconfig, init, mkfs, mkswap, reboot, routeなどが規定されている

### /etc

システムやアプリケーションの設定情報、スクリプトファイルなどが配置される

### /dev

ハードディスクやDVD-ROMなどのデバイスファイルが配置される

デバイスファイルは特殊ファイルで、デバイスに応じたデバイスファイルが必要

### /lib

共有ライブラリやカーネルモジュールが配置される

/bin, /sbinにあるコマンドが必要とするライブラリはここに配置される

### /media

DVD-ROMなどリムーバブルメディアのマウントポイントが配置される

### /mnt

一時的にマウントするファイルシステムのマウントポイントが配置される

### /opt

パッケージ管理の仕組みを使ってプログラムがインストールされるディレクトリ

ディストリビューションによっては配置されない

### /proc

カーネル内部の情報にアクセスするための仮想的なファイルシステム

このディレクトリ内のファイルはファイルのように見えるだけで、実際にディスク上には存在しない

### /root

スーパーユーザーrootのホームディレクトリ

/homeファイルシステムがマウントできなくなった場合でも、システムのメンテナンスを行うことができるよう、/homeとは別になっている

=> FHSではオプション扱い

### /boot

起動に必要な設定やカーネルイメージが配置される

起動時にBIOSの制限を受けないようにするため、ルートファイルシステムとは別にディスクの先頭付近に配置されることがある

### /home

ユーザーごとのホームディレクトリが置かれる

独立したファイルシステムにすることにより、クォータ設定することができたり保守性を向上させたりできる

=> FHSではオプション扱い

### /tmp

一時ファイルが置かれる(すべてのユーザーが読み書き可能)

### /var

ログファイル、メールやプリンタのスプールなど、頻繁に書き換えられるファイルが配置される

/varディレクトリ以下はされに細分化されており、以下のようなディレクトリがある

- /var/cache

  manコマンドで表示するために整形したデータなど、一時的なキャッシュファイルが配置される

- /var/lock

  アプリケーションが排他制御に使うためのロックファイルが配置される

- /var/log

  ログファイルが書き出される

  システムのログファイル: `message`, メールシステムのログファイル: `maillog`, `mail.log`など

- /var/run

  システムの状態を示すファイルが配置される

  PIDが格納されたファイルを見ると、PIDを調べることができる

  => httpd.pidファイルには、httpdプロセスIDが格納されている

  httpd.pidを使ってhttpdを再起動:

  ```
  kill -HUP `cat /var/run/httpd.pid`
  ```

- /var/spool

  印刷待ちのデータ(/var/spool/lpd)や予約されたジョブ(/var/spool/at)など、処理待ちデータが配置される

### /usr

コマンドやユーティリティなどが配置される

- /usr/bin

  ユーザーが一般的に使用するコマンドで、緊急時のシステム保守に必須でないコマンドが配置される

- /usr/sbin

  システム管理コマンドで、緊急時のシステム保守に必須でないコマンドが配置される

- /usr/lib

  プログラムに必要な共有ライブラリが配置される

- /usr/local

  ローカルシステムで必要とされるコマンドやライブラリ、ドキュメントなどが配置される

  => さらにbin, sbin, libなどのディレクトリに細分化される

- /usr/share

  x86やx86_64といったシステムアーキテクチャに依存しないファイルが配置される

  例えば、/usr/share/manにはmanコマンドで使うマニュアルが配置される

- /usr/src

  Linuxカーネルソースなど、ソースコードが配置される

## 2 ファイルの検索

### findコマンド

指定したディレクトリ以下から、検索条件にマッチするファイルやディレクトリを検索する

ファイル名だけでなく、アクセス権やフィアルサイズ、更新日時などを併用して検索可能

検索条件にメタキャラクタが使えるほか、検索条件にマッチしたファイルに対してアクション(削除など)高度な処理が可能

検索ディレクトリを省略した場合は、カレントディレクトリが検索対象になる

検索対象ディレクトリにアクセスできる権限を持っている必要があることに注意

=> 一般ユーザーのアクセスが禁止されているディレクトリを、一般ユーザーがfindで検索することはできない

```
find [検索ディレクトリ] [検索式]
```

findコマンドの主な検索式:

| 検索式               | 説明                                                                     |
|----------------------|--------------------------------------------------------------------------|
| -name ファイル名     |ファイル名で検索                                                          |
| -atime 日時          |最終アクセス時刻で検索                                                    |
| -mtime 日時          |最終更新時刻で検索                                                        |
| -perm アクセス権     |アクセス権で検索                                                          |
| -size サイズ         |ファイルサイズ(ブロック単位)で検索                                        |
| -type ファイルの種類 |ファイルの種類で検索(f: ファイル, l: シンボリックリンク, d: ディレクトリ) |
| -user ユーザー名     |ファイルの所有者で検索                                                    |
| -print               |マッチしたファイルを表示する(省略可能)                                    |
| -exec コマンド {}\;  |マッチしたファイルに対してコマンドを実行                                  |
| -ok コマンド {}\;    |マッチしたファイルに対してコマンドを実行(確認あり)                        |

/homeディレクトリ以下から、ファイル名の末尾が`.rpm`のファイルを検索:

```
find /home -name "*.rpm"
```

/dataディレクトリ以下から過去1日以内に更新されたファイルを検索:

```
find /data -type f -mtime -1
```

/usr/binディレクトリ以下からSUIDが設定されたファイルを検索:

```
find /usr/bin -type f -perm -u+s
```

/tmpディレクトリ以下から所有者がjohnであるファイルやディレクトリを検:

```
find /tmp -user john
```

カレントディレクトリ以下から30日を超える日数の間アクセスされていないファイルを検索して削除:

```
find -atime +30 -exec rm {}\;
```

### locateコマンド

あらかじめ作成されたデータベースに基づいて、指定されたパターンに一致するファイルを検索

findコマンドよりも高速に動作するが、findコマンドのような細かい機能はない

ファイル名が`.c`で終わるファイルを検索:

```
locate "*.c"
```

locateコマンドはファイル名データベースによって検索するので高速だが

データベース更新後に作成・変更されたファイルは見つけることができない

=> データベースの更新は`updatedb`コマンドを使用する

=> `-e path`で`path`をデータベースに取り込まないパスとして指定

updatedbコマンドは、多くのディストリビューションではcronを用いて定期的に更新される

updatedbコマンドの動作を変更するには、`/etc/updatedb.conf`を編集する

### whichコマンド

コマンドを探し出して絶対パスを表示する

```
which ls # => /usr/bin/ls
```

環境変数PATHに基づいて検索を行うため、一般ユーザーが管理者用コマンドを検索することはできない

=> ディストリビューションによってはPATH変数の設定によって検索できることもある

### whereisコマンド

指定されたコマンドのバイナリファイル、ソースコード、マニュアルファイルが置かれている場所を検索

- `-b`: バイナリファイルのみ検索
- `-m`: マニュアルファイルのみ検索
- `-s`: ソースファイルのみ検索

```
whereis ls # => ls: /usr/bin/ls /usr/share/man/man1/ls.1.gz
```

### typeコマンド

指定したコマンドが通常の実行ファイルなのか、シェルの組み込みコマンドなのか、エイリアスなのか

```
type cat
cat is /usr/bin/cat # 外部コマンド

type echo
echo is a shell builtin # 組み込みコマンド

type ls
ls is aliased to `ls --color=auto' # エイリアス

type for
for is a shell keyword # シェルの予約語
```

