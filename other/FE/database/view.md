# ビュー

## 更新不可能なビュー

ビューを更新可能とするためには、ビュー定義に以下の後続を含めてはいけない。

- 1 : 集約関数(AVG, COUNT, SUM, MIN, MAXなど)
- 2 : 2つ以上の表の結合(更新可能な結合、和集合及び列を除く)
- 3 : GROUP BY, ORDER BY, MODEL, CONNECT BY, START WITH, DISTINCTの各句
- 4 : SELECT構文のリストにコレクション式
- 5 : SELECT構文のリストにある副問合せ
- 6 : WITH READ ONLYが指定された副問合せ

### 句

| 句                                  | 内容                                                           |
|-------------------------------------|----------------------------------------------------------------|
| `GROUP BY`                          | 集約関数とセットで使う。行がまとまるので更新不可。             |
| `ORDER BY`                          | 表示順だけで意味があるが、ビューには使えない。                 |
| `MODEL`, `CONNECT BY`, `START WITH` | Oracle特有の構文（階層・計算など）で通常のビューを複雑にする。 |
| `DISTINCT`                          | 重複行を削除。=> どの「元の行」を更新すべきかが不明になる。    |

### コレクション式

1つのカラムに、複数の値(リストや配列)が入っているようなもの。

例: `array_agg()`などの集約関数で複数の値を1つにまとめるやつ

```
SELECT
  department,
  ARRAY_AGG(name) AS members
FROM employees
GROUP BY department;
```

- ARRAY_AGG(name)は同じ部署の名前をまとめて配列(リスト)にする
- 結果はこう :dog:

| department | members             |
|------------|---------------------|
| Sales      | {Alice,Bob}         |
| IT         | {Charlie,David,Eve} |

まとめ：コレクション式とは？

| 特徴       | 内容                                                       |
|------------|------------------------------------------------------------|
| 定義       | 1セルに複数の値(配列・リスト)を入れるような式              |
| 例         | `ARRAY_AGG()`, `string_agg()`, サブクエリで返す配列        |
| ダメな理由 | どの元データの行に戻せばいいか分からないため、更新できない |

