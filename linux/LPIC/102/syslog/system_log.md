# システムログ

Linuxでは`syslog`を使用してさまざまなイベントをログファイルに記録したり、コンソールに表示することができる。

`syslog`は他のプログラムからのメッセージを受け取り、出力元や優先度に応じて分類し、指定された出力先に送る。

システムのログを取得して管理するソフトウェアには`syslog`のほかに`rsyslog`, `syslog-ng`などが使われている。

---

# rsyslog

rsyslogの設定は、`/etc/rsyslog.conf`および`/etc/rsyslog.d`ディレクトリ以下のファイルで行う。

## プラグインモジュール

rsyslogでは各種機能をプラグインモジュールによって拡張ができるようになている。

| プラグインモジュール | 説明                                                           |
|----------------------|----------------------------------------------------------------|
| imuxsock             | UNIXソケットによるローカルロギングサポート(loggerコマンドなど) |
| imklog               | カーネルログのサポート                                         |
| imjournal            | systemdのジャーナルサポート                                    |
| immark               | マークを出力(--MARK--)                                         |
| imudp                | UDPでメッセージを受信                                          |
| imtcp                | TCPでメッセージを受信                                          |

```
# /etc/rsyslog.confのモジュール設定部分例
$ModLoad imuxsock
$ModLoad imjournal
$ModLoad imklog
$ModLoad immark
```

=> デフォルトでは`imuxsock`, `imklog`モジュールのみが有効になっている

## ルール設定

どのようなメッセージをどこに出力するかなどの設定を行う箇所。

`/etc/rsyslog.conf`, `/etc/rsyslog.d/*.conf`ファイルで設定。

=> 各設定はデフォルトでは`#`でコメントアウトされている

### ルール設定の書式

```
ファシリティ.プライオリティ 出力先
```

ログメッセージ生成元のプログラムはメッセージにファシリティとっプライオリティをタグ付けする。

```
#### RULES ####

# カーネルメッセージはコンソールに出力
kern.*    /dev/console
```

=> `*`はすべてのファシリティ/プライオリティを選択するの意味


### ファシリティ

ファシリティ(facility)はメッセージの生成元を表す。

=> カーネルや実行中のプロセスなど

| ファシリティ   | 説明                               |
|----------------|------------------------------------|
| auth, authpriv | 認証システム(loginなど)による出力  |
| cron           | cronによる出力                     |
| daemon         | 各種デーモンによる出力             |
| kern           | カーネルによる出力                 |
| lpr            | 印刷システムによる出力             |
| mail           | メールサービス関連による出力       |
| user           | ユーザーアプリケーションによる出力 |
| local01~local7 | ローカルシステムの設定             |

### プライオリティ

プライオリティ(priority)はメッセージの重要度を表す。

=> 低く設定すればログとしての情報量は多くなる

以下は優先度の高い順のプライオリティ:

| 重要度  | 説明                                       |
|---------|--------------------------------------------|
| emerg   | 緊急事態                                   |
| alert   | 早急に対処が必要な事態                     |
| crit    | システムの処理は継続できるものの深刻な事態 |
| err     | 一般的なエラー                             |
| warning | 一般的な警告                               |
| notice  | 一般的な通知                               |
| info    | 一般的な情報                               |
| debug   | デバッグ情報                               |
| none    | ログを記録しない(特殊)                     |

=> `none`は例外で。指定されたファシリティのログを除外する役割を持つ

ファシリティとプライオリティを合わせて`セレクタフィールド`といい、`;`区切りで複数を列挙できる。

```
# メインログ(/var/log/messages)の設定例
*.info;mail.none;authpriv.none;cron.none    /var/log/messages
```

### 出力先

メッセージの出力先は、ログファイルやユーザー端末、他ホストなどの選択ができる。

=> この部分を`アクションフィールド`という

| アクションフィールド | 説明                                     |
|----------------------|------------------------------------------|
| /var/log/messages    | ログファイルに出力                       |
| /dev/tty1            | コンソール(tty1)に出力                   |
| @sv.example.com      | ホストsv.example.comにUDPで出力          |
| @@sv.example.com     | ホストsv.example.comにTCPで出力          |
| violet               | ユーザーvioletの端末に出力               |
| *                    | ログイン中のすべてのユーザーの端末に出力 |

- UDP : 速い・軽い・信頼度低い
- TCP : 遅め・重め・信頼度高い

### その他

指定したファシリティが出力するメッセージのうち、指定プライオリティ以上のものが出力先に出力される。

プライオリティを`info`に設定すると、`emerg`から`info`までの重要度が指定される。

プライオリティの前に`.`ではなく、`=`を指定すると、指定したプライオリティのみにある。

出力先ログファイルの先頭に`-`がついていれば、メッセージの書き込みごとに同期をしない。(バッファリングを使用)

=> パフォーマンスが向上するが、クラッシュ時に一部ログを失う可能性あり

rsylogの設定を変更した場合は、`rsyslog.service`の再起動、もしくは設定ファイルの再読み込みが必要。

