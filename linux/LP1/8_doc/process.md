# プロセス

プロセスとは、システム上で動作しているプログラムの最小単位のこと。

PID(プロセスID)およびプロセス名(コマンド名)は`ps`コマンドなどで調べることができる。

`pgrep`コマンドでは実行中のプロセスから特定の名前を持つプロセスIDを検索することができる。

`kill`, `killall`, `pkill`コマンドでは、プロセスに終了や再起動などのシグナル(命令)を送ることができる。

---

## ps

psコマンドは、現在実行中のプロセスの一覧を表示するコマンド。

プロセスの状態やPID、実行ユーザーなどの情報を確認するのに使われる。

オプションなしでpsコマンドを実行すると、自分のシェルとそのシェル上で動いているプロセスが表示される。

### オプション

psコマンドのオプションには`-`ありのオプションと`-`なしオプションあり。

| オプション | 動作                                              |
|------------|---------------------------------------------------|
| -e         | システム上のすべてのプロセスを表示                |
| -f         | 詳細情報を表示(UID, PID, PPID, CMDなど)           |
| a          | 端末(TTY)に関するすべてのユーザーのプロセスを表示 |
| u          | ユーザーごとのプロセスを表示                      |
| x          | 端末を持たないプロセス(デーモンなど)も表示        |

`grep`コマンド組み合わせて特定のプロセスを検索することなども可能。

```
ps aux | grep postgres
```

## pgrep

特定のプロセスの検索をするコマンド。 => `ps aux | grep xxx`とは少し動作が異なる

```
pgrep postgres
```

postgresという名前のPIDだけが表示される。 => ユーザーなど詳細はデフォルトでは表示されない 

検索パターンには拡張正規表現を指定することが可能。例: `pgrep -l '(as|ss)h'`

### オプション

| オプション    | 動作                               |
|---------------|------------------------------------|
| -l            | プロセス名も表示                   |
| -a            | 実行コマンドのフルパスも表示       |
| -u ユーザー名 | 特定のユーザーのプロセスを検索     |
| -U ユーザーID | 指定したユーザーIDのプロセスを検索 |

## kill

killコマンドでは特定のプロセスを終了させたり、特定のシグナル(後述)を送ることが可能。

```
kill [オプション] PID
```

- PIDを指定してプロセスを終了
- killのデフォルト動作はSIGTERM(15)シグナルを送る

## シグナル名とシグナル番号

| シグナル名    | シグナル番号 | 動作                                     |
|---------------|--------------|------------------------------------------|
| HUP(SIGHUP)   | 1            | ハングアップ(端末の切断による終了)       |
| INT(SIGINT)   | 2            | 割り込みによる終了(Ctrl+Cと同じ)         |
| KILL(SIGKILL) | 9            | クリーンアップせずに終了(強制終了)       |
| TERM(SIGTERM) | 15           | クリーンアップして終了(これがデフォルト) |
| CONT(SIGCONT) | 18(環境依存) | 一時停止のプロセスを再開                 |
| STOP(SIGSTOP) | 19(環境依存) | 一時停止                                 |
| TSTP(SIGTSTP) | 20(環境依存) | 一時停止(Ctrl+Zと同じ)                   |

SIGHUP(シグナル1)は「端末の切断による終了」と「設定の再読み込み」の2つの意味で使われる。

一部のデーモンでは`SIGHUP`を受け取ると再起動せずに設定ファイルを再読み込みするという動作をする。

```
# シグナルの指定
kill -シグナル名 PID
kill -シグナル番号 PID

# これでもいける
kill -s シグナル名 PID
kill -s シグナル番号 PID

# 以下は全部同じ(PID=1000を強制終了)
kill -SIGKILL 1000
kill -9 1000
kill -s SIGKILL 1000
kill -s 9 1000
```

```
# Apacheを設定変更なしで再読み込み
kill -SIGHUP $(pgrep apache2)
```

killコマンドではジョブ番号を指定し、ジョブに対してシグナルを送ることも可能。

=> ジョブ番号は`%ジョブ番号`と指定する(例: `kill %2`)

=> ジョブ番号は`jobs`コマンドで確認が可能

## killall / pkill

killallコマンドはプロセス名を指定して、その名前のすべてのプロセスを終了する(シグナルを送る)コマンド。

killでは`PID`を指定するのに対し、killallは`プロセス名`で一括終了できるのが特徴。

指定するプロセス名は完全一致でないとヒットしない。

プロセス名を`部分一致`でヒットさせる際には`pkill`コマンドを使用する。

=> `killall -r`を使用すれば正規表現でプロセス名を指定することは可能

