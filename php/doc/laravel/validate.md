# バリデーション

## コントローラ内でのバリデーション

小規模・簡易CRUDなどでは、コントローラ内でバリデーションを書くこともある。

`Illuminate\Http\Request`オブジェクトが持つ`validate()`メソッドを利用する。

### コントローラ

```php
<?php
// Request $request は必ず必要
public function sotre(Request $request)

{
  $request->validate([
    // 'フィールド名' => 'ルール1'|'ルール2'|'ルール3',
    'name' => 'required|string|max:255',
    'power' => 'required|integer|min:0|max:255'
  ]);

  $request->validate([
    // 配列形式で記述する方が、複雑なルールやメッセージ指定に便利
    'speed' => ['required', 'integer', 'min:0', 'max:999'],
  ]);
}
```

- 引数: `store`メソッドは必ず`Request $request`を受け取る必要があります
- 連想配列: `validate()`メソッドには連想配列を渡す
  - キー: フォームから送られてくるデータの`name`属性(フィールド名)を指定
  - 値: そのフィールドに適用したいバリデーションルール(検証規則)をパイプで区切った文字列、または配列として指定

## バリデーションの仕組み

`$request->validate()`メソッドは、実は内部で非常に強力な動作をしている。

### 検証の実行と成功時の処理

`validate()`メソッドが呼ばれると、Laravelはリクエストデータに対してすべてのルールを順番にチェックする。

全てのルールを通過した場合、`validate()`は何もせず処理は次の行へと進む。

### 失敗時の自動処理

1つでもルールに違反するデータがあった場合、`validate()`メソッドは自動的に処理を中断し、以下の処理を実施

- `Illuminate\Validation\ValidationException`の例外を投げる
- Laravelの例外ハンドラがこの例外をキャッチ
- 例外ハンドラは、自動的にユーザーを直前のページ(フォーム画面)にリダイレクトさせる
- リダイレクトと同時に、エラーメッセージと入力値の内容をセッションに自動保存する

=> エラーだったらリダイレクトみたいな処理を書く必要がない

### 入力値の保持(old()ヘルパー)

`input`フォームに`value="{{ old('name') }}"`のようにする。

セッションに保存された古い入力値を取り出して、ユーザーの入力し直す手間を省ける。

