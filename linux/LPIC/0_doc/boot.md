# Linux ブートプロセス

## 起動プロセスの流れ

- 1: BIOS/UEFI
- 2: ブートローダー
- 3: Linuxカーネルの初期化
- 4: initシステムの実行
- 5: ログインプロンプトの表示

## 1.BIOS/UEFI

電源投入後、BIOS(Basic Input/Output System)またはUEFI(Unified Extensible Firmware Interface)が最初に動作する。

- 動作内容:
  - ハードウェアの初期化(CPU, メモリ, ディスク, キーボードなど)
  - ブートデバイス(HDD, SSD, USBなど)を特定
  - ブートローダー(次のステージ)をロード

## 2.ブートローダー(Boot Loader)

OSのカーネルをメモリにロードして実行する。

GRUB, GRUB2が多くのLinuxディストリビューションで採用されている。

- 動作内容:
  - 設定ファイルを読込む
  - ユーザーにブートメニューを表示(複数のOSやカーネルの選択肢がある場合)
  - 選択したカーネルをロードし、カーネルに制御を渡す

### GRUB(GRUB Legacy)

バージョン番号は0.9x。

GRUBの設定ファイルは`/boot/grub/menu.lst` => 手動で編集が可能。変更後は即座に反映。

ディストリビューションによっては`/boot/grub/grub.conf`の場合もあり。

### GRUB2

バージョンは1.9x以降。

GRUB2の設定ファイルは`/boot/grub/grub.cfg` => このファイルを直接編集することはない。

設定内容は`/etc/default/grub`ファイルおよび`/etc/grub.d`ディレクトリ内のファイルに記述し、`grub-mkconfig`コマンドで設定内容を`/boot/grub/grub.cfg`ファイルに反映させる。

## 3.カーネルの初期化

Linuxカーネルがメモリ内で起動し、基本的なハードウェアやシステムリソースを管理する。

- 動作内容:
  - ハードウェアデバイスを検出し、ドライバを初期化
  - ルートファイルシステムをマウント
  - initプロセス(PID 1)を起動

## 4.initシステムの実行

システム全体の初期化とサービスの起動を行う。

- 主な種類:
  - SysVinit(従来の方式)
  - Systemd(現在多くのLinuxディストリビューションで採用)
  - Upstart(一部のディストリビューションで採用)

- 動作内容:
  - 設定ファイルを基に、適切なランレベルまたはターゲットを読込む。
  - 必要なサービスやデーモンを起動

## 5.ログインプロンプトの表示

システムがユーザーの入力を受け付ける状態になる。

- 動作内容:
  - コンソールログイン(CLI環境)またはディスプレイマネージャー(GUI環境)が起動
  - ユーザ認証が行われ、シェルまたはデスクトップ環境にアクセス可能となる

---

# boot

BIOS => ブートローダ => カーネル => init

- BIOS:

  物理的なハードウェア(マザーボート)上に書込まれている。

  PCの電源ONでまずBIOSが起動 => 記憶装置(HDD)などを最低限錦 => 起動デバイスの優先順位を決定

  その後、優先順位に従って各デバイスの先頭セクタにあるMBR(ブート用の特殊領域: ブートローダが格納)を読み込み、得られたブートローダに制御を移す。

  ブートローダが得られない場合は次のデバイスのMBRを読込む。

- ブートローダ

  LinuxシステムではGRUBが該当。

  MBRに格納されている第一段階部分と、記憶装置内の別の場所に格納されている第二段階部分がある。

  (MBRには厳しいサイズ制限がある)

  ブートローダは記憶装置内のカーネルをロードし、カーネルに制御を移す、

  第一段階のブートローダはMBRの先頭446バイトの領域にインストールされる。

  - ブートストラップローダ(446バイト)
  - 第1パーティション情報(16バイト) パーティションテーブル
  - 第2パーティション情報(16バイト) パーティションテーブル
  - 第3パーティション情報(16バイト) パーティションテーブル
  - 第4パーティション情報(16バイト) パーティションテーブル
  - ブートシグニチャ(2バイト)

  `合計: 512バイト`

- カーネル

  カーネルは起動されると、高度にハードウェアを認識・制御し、ルートファイルシステムのマウントなど様々な初期化処理を行う。

  ブートローダはカーネルと初期RAMディスク(initramfs)の内容をメモリ上に展開。

  その後、カーネルはメモリ上に展開された初期RAMディスク内の、ファイルシステムへアクセスするために必要なドライバやスクリプトを使用してルートファイルシステムをマウントする。

  そして、initという特別な最初のプロセスをルートファイルシステムから起動する。

- init

  最初に起動されるプロセスで、PIDは必ず`1`。

  従来のSysVinitと呼ばれるinitプログラムを採用しているシステムでは、`/sbin/init`が起動される。

  initプロセスは設定ファイル`/etc/inittab`の記述に基づいて、自動起動するべきプロセスを立ち上げるなど、アプリケーションの初期化を行う。

  最近のシステムではinitプログラムとして、初期化処理を高速化した`Upstart`や`systemd`を採用している場合が多い。(その場合は/etc/inittabファイルは使用されない)

---

