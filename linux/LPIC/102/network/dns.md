# DNS(Domain Name System)

DNSとは`ドメイン名(ホスト名)`を`IPアドレス`に変換する仕組み。

=> `名前解決`という

- 正引き : ホスト名からIPアドレスを求める
- 逆引き : IPアドレスからホスト名を求める

ホスト名は`www.google.com`のように表す。

- `www` : ホスト名
- `google.com` : ドメイン名

ホスト名といった場合、`www`だけのことも、`www.google.com`のように省略しない名前のことを指す。

=> `www.google.com`のようい省略しない名前を`FQDN(Fully Qualified Domain Nmae : 完全修飾ドメイン名`という

## ルートドメイン

`www.google.com`は左から右に向かって下層階層 => 上位階層になっており、下記のように分解できる。

| 階層     | 内容                           |
|----------|--------------------------------|
| www      | ホスト名(サブドメイン)         |
| google   | セカンドレベルドメイン(組織名) |
| .com     | トップレベルドメイン(TLD)      |
| (空文字) | ルートドメイン(省略される)     |

=> ルートドメインは`.(ドット)`で普段は省略されている

DNSでは名前解決する時に、上の階層から順番にたどっていく。

=> ルートDNS => TLD DNS => 権威DNS の順番で探しにいく

## /etc/resolv.conf

DNSによる名前解決を利用するには、どこにあるDNSサーバーを参照するか設定する必要がある。

参照先DNSサーバーは`/etc/resolv.conf`ファイルに設定する。

```
# /etc/resolv.conf
domain example.com
search example.com
nameserver 192.168.10.254
nameserver 8.8.8.8
```

- domain行 : このホストが属するドメイン名 => 1つだけ補完ドメインを指定
- search行 : ドメイン名が省略された際に補完するドメイン名 => 複数の候補ドメインを指定可能
- nameserver : 参照先DNSサーバーIP(複数指定可能(3つまで)・上から参照していき、最初の応答があったサーバーを使用)

## /etc/nsswitch.conf

GNU Cライブラリが名前解決やサービス名解決の際に問合せ順序を指定するファイル。

=> ユーザー情報、パスワード情報の取得、ホスト名からIPアドレスを取得する際の情報検索先など設定内容は多岐にわたる。

=> この中にある`hosts:`の行が名前解決時にどの順で見るかを制御している

```
# /etc/nsswitch.conf
hosts: files dns ldap
```

この場合は、まず`/etc/hosts`を見て、次に`DNSサーバー`、その次にLDAPサーバーを使うという意味。

---

# systemd-resolved

systemd採用ディストリビューションでは、名前解決に`systemd-resolved`サービスが使われている。

設定は`/etc/systemd/resolved.conf`ファイルで行う。

systemd採用ディストリビューションでは、`/etc/resolv.conf`ファイルは`/run/systemd/resolve/...`などのシンボリックリンクになっていることが多い。

---

# DNS管理コマンド

DNSを使用して名前解決を行うコマンドは、`host`, `dig`, `nslookup`, `getnet`がある。

## hostコマンド

DNSサーバーを使ってホストやドメインに関する情報を表示するコマンド。

`dig`, `nslookup`と比べて出力する情報はシンプル。

デフォルトではホスト名とIPアドレスの変換を行う。

`host [オプション] ホスト名 or IPアドレス [DNSサーバーアドレス]`

```
# 正引き
host www.google.com # => www.google.com has address 172.217.161.68

# 逆引き
host 8.8.8.8 # => 8.8.8.8.in-addr.arpa domain name pointer dns.google.

# 特定のDNSサーバーを使用する
host www.google.com 8.8.8.8

# メールサーバー情報を確認
host -t MX google.com
```

### オプション

- -t : 問い合わせる情報の指定(type)
- -v : 詳細な出力(verbose)

=> `-t`で指定する情報がdigコマンドと同じく、a: IPアドレス, mx: メールサーバー, ns: ネームサーバー, any: すべて

## digコマンド

DNSサーバーに登録されている情報を詳しく表示するコマンド。

知りたい情報のタイプは検索タイプで指定する。

`dig [オプション] [@DNSサーバー名] ホスト名orドメイン名 [検索タイプ]`

```
dig @8.8.8.8 www.google.com # @の後にDNSサーバーを指定できるのがdigの特徴

dig google.com MX           # hostコマンドと指定の仕方が違うのに注意
```

### オプション

- -x : IPアドレスからホスト名を検索する
- +short : 結果だけを簡潔に表示

### 検索タイプ

| 検索タイプ | 説明                             |
|------------|----------------------------------|
| a          | IPアドレス                       |
| aaaa       | IPv6アドレス                     |
| any        | すべての情報                     |
| mx         | メールサーバーの情報             |
| ns         | ネームサーバーの情報             |

## nslookup

これも名前解決系コマンド。

シンプルな表示で初心者にもわかりやすい。

hostコマンドと同じく、最後にDNSサーバーを指定できる。

```
nslookup www.google.com 8.8.8.8
```

## getnet

名前解決の順序を設定する`/etc/nsswitch.conf`に従って検索を行うコマンド。

検索したいサービス(ホストの名前解決は`hosts`)とホスト名を指定して検索する。

```
getnet hosts google.com
```

---

# 名前解決系コマンドまとめ

| コマンド   | 特徴                                                   | 出力の詳細 | 学習向き   | 一言で言うと                 |
|------------|--------------------------------------------------------|------------|------------|------------------------------|
| `host`     | シンプルで見やすい、DNSレコードも指定可能              | 少なめ     | 初級者     | 簡単に結果を知りたい人向け   |
| `dig`      | 詳細な情報を表示、+shortで要約もできる                 | 多い       | 中〜上級者 | ネットワークエンジニア御用達 |
| `nslookup` | 昔からある、対話モードがある、出力は比較的わかりやすい | 中くらい   | 初級者     | レガシーだけど使えるやつ     |
| `getent`   | 検索サービスに`hosts`を指定で名前解決できる            | 少ない     | ？         | 他にもいろいろできるやつ     |

