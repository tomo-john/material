# su

`substitute user`の略で、ユーザーを一時的に切り替えて、そのユーザーの権限で操作を行うコマンド。

`su - john`で一時的にユーザーjohnに切り替えることができる。

=> パスワードを聞かれるので、指定したユーザー(この場合john)のパスワードを入力

=> 元のユーザーに戻るときは`exit`

ユーザー名を省略すると`root`ユーザーを指定したこととなる。

## - の意味

`-`をつけることで、そのユーザーで直接ログインしたとき同様に環境がリセットされる。

=> 新しいカレントディレクトリはそのユーザーのホームディレクトリとなり、環境変数などもすべて(そのユーザーの設定で)初期化される

`-`がなければ現在の環境をそのままにしてユーザーだけを切り替える。

---

# sudo

`superuser do`の略で、一時的に他のユーザー(多くはroot)の権限でコマンドを実行するためのコマンド。

- rootに完全になりきる`su`と違って、`sudo`はコマンド単位で特権を与える
- 安全性が高く、ログにも記録されるので最近は`su`より`sudo`を使うのが一般的
- 入力するパスワードはrootのパスワードではなく`sudo`を実行するユーザーのパスワード

=> 一般ユーザーの`john`に`shutdown`コマンドだけは許可してやろうみたいなことができる

sudoを使えるユーザーや許可されたコマンドの設定は`/etc/sudoers`ファイルで管理される。

=> `visudo`コマンドで編集する(直接エディタで編集はミスると危険なので行わない)

## オプション

- -l : 許可されているコマンドを表示
- -i : 変更先ユーザーでシェルを起動する(ログイン時の処理を行う)
- -s : 変更先ユーザーでシェルを起動する
- -u : rootではなく指定したユーザーでコマンドを実行する

`-i`は`su -`に近い動き、`-s`は`su`に近い動き。

## visudo

`/etc/sudoers`ファイルを編集するコマンド。(デフォルトのエディタで)

=> 構文エラーなど教えてくれるので安全

## /etc/sudoers

| 項目           | 説明                                                    |
|----------------|---------------------------------------------------------|
| ユーザー名     | コマンドの実行を許可するユーザー名 or グループ名 or ALL |
| ホスト名       | 実行を許可するホスト名 or IPアドレス or ALL             |
| 実行ユーザー名 | コマンド実行時のユーザー名(省略するとroot) or ALL       |
| コマンド       | 実行を許可するコマンドのパス or ALL                     |
| NOPASSWD:      | 指定すると、コマンド実行時にパスワードを問われない      |

```
<ユーザー名> <ホスト名>=(<実行ユーザー>) <許可するコマンド> [NOPASSWORD:<対象>]
```

### ALL

```
john ALL=(ALL) ALL
```

- john : 対象ユーザーjohnはsudoが使える
- ALL : どのホストからでも有効(ローカル用はALL)
- (ALL) : どのユーザーとしても実行可能
- ALL : すべてのコマンドを実行可能

### 特定のコマンドを許可

```
john ALL=(ALL) /sbin/shutdown
```

- johnはshutdownだけ実行できる

### グループ単位で許可

```
%animal ALL=(ALL) ALL
```

- animalグループに属するユーザー全員がsudoを使用できる
- `%`をつけるとグループ指定になる

### パスワードなしで実行

```
john ALL=(ALL) NOPASSWD:ALL
```

- johnユーザーはsudo実行時にパスワード入力が不要

### コマンドを制限付きで許可

```
john ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx
```

- johnユーザーは`nginx`の再起動だけsudoでパスワードなしで実行可能

