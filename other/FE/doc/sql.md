# SQL

SQL(Structured Query Language)とは、関係データベースを操作するための言語。

`ユーザー --操作--=> アプリケーションソフトウェア --操作--=> RDBMS --操作--=> データベース`

アプリケーションソフトウェアからRDBMSに対して命令を出すときに使用するのがSQL。

- 1 : アプリケーションソフトウェアからRDBMSにSQLで命令
- 2 : RDBMSからデータベースを操作
- 3 : RDBMSからアプリケーションソフトウェアへ結果を返す

## データ操作

| 操作 | 説明                                 | SQL       |
|------|--------------------------------------|-----------|
| 選択 | テーブルから特定のレコードを取り出す | SELECT    |
| 射影 | テーブルから特定の列(属性)と取り出す | SELECT    |
| 結合 | 複数のテーブルを1つにする            | `,`(JOIN) |
| 挿入 | テーブルにレコードを追加する         | INSERT    |
| 更新 | レコード内のデータを更新する         | UPDDATE   |
| 削除 | テーブルからレコードを削除する       | DELETE    |

## SELECT

テーブルからデータと取り出す。選択や射影ができる。

=> `SELECT 列(属性) FROM テーブル名 WHERE 条件`

- SELECT : 取り出したい列(属性)を指定。`*`とすると、すべての列を取り出す。複数の列を指定するときは`,`で区切る。
- FROM : 対象のテーブル名を指定する。
- WHERE : 特定の行(レコード)を取り出すための条件を指定する。

## WHERE句

`WHERE 列名 演算子 値`

=> SELECT * FROM animals WHERE name = 'じょん';

=> SELECT * FROM animals WHERE id >= 10;

### 比較演算子

| 比較演算子 | 意味       |
|------------|------------|
| `=`        | 等しい     |
| `<>`       | 等しくない |
| `>`        | より大きい |
| `<`        | より小さい |
| `>=`       | 以上       |
| `<=`       | 以下       |

- 値が文字列の時は`'(シングルクォート)`で値を囲む
- 値が数値の時は囲まない

### 論理演算子

| 論理演算子 | 意味   |
|------------|--------|
| AND        | かつ   |
| OR         | または |
| NOT        | 否定   |

- 例 : `SELECT * FROM animals WHERE id >= 10 OR name = 'じょん';`

## テーブル結合

ここではJOINは使用しない。

- 1 : FROMの後に対象テーブルを`,`区切りで指定する
- 2 : WHWRE句で2つのテーブルを紐づけるための列名を指定する

=> テーブル結合するには、すべてのテーブルに共通して存在する列を指定する必要あり

```
SELECT 列名
FROM テーブルA, テーブルB              # 1
WHERE テーブルA.列名 = テーブルB.列名; # 2
```

```
# usersテーブル
SELECT * FROM users;

 id |    name
----+-------------
  1 | john
  2 | pyonkichi
  3 | mocomoca
  4 | super_john2

# postsテーブル
SELECT * FROM posts;

id  | user_id |   title   |        content
----+---------+-----------+-----------------------
  1 |       1 | Hello Dog | こんにちわんわん
  2 |       1 | Notice    | 犬はすごい
  3 |       2 | Rabbit    | ぴょーんぴょーん
  4 |       4 | Super     | スーパーサイヤじょん2

# 結合してみる(全属性表示)
SELECT * FROM users, posts WHERE users.id = posts.user_id;

 id |    name     | id | user_id |   title   |        content
----+-------------+----+---------+-----------+-----------------------
  1 | john        |  1 |       1 | Hello Dog | こんにちわんわん
  1 | john        |  2 |       1 | Notice    | 犬はすごい
  2 | pyonkichi   |  3 |       2 | Rabbit    | ぴょーんぴょーん
  4 | super_john2 |  4 |       4 | Super     | スーパーサイヤじょん2

# 表示する属性を指定
SELECT name, title, content FROM users, posts WHERE users.id = posts.user_id;

    name     |   title   |        content
-------------+-----------+-----------------------
 john        | Hello Dog | こんにちわんわん
 john        | Notice    | 犬はすごい
 pyonkichi   | Rabbit    | ぴょーんぴょーん
 super_john2 | Super     | スーパーサイヤじょん2
```

### 自然結合

異なる2つのテーブルに、同じ名前の列がある場合、自然的にその列を用いてテーブルを紐づける結合。

=> 同じ名前の列で結合する便利なJOIN

## データ集計

| 関数        | 説明                       |
|-------------|----------------------------|
| `SUM(列名)` | 指定した列の合計を求める   |
| `AVG(列名)` | 指定した列の平均を求める   |
| `MIN(列名)` | 指定した列の最小値を求める |
| `MAX(列名)` | 指定した列の最大値を求める |
| `COUNT(*)`  | 行数を求める               |

=> `SELECT SUM(列名) FROM tables;`のようにSELECTの後に`関数(列名)`で指定

=> `COUNT(*)`はアスタリスク

## グループ化(GROUP BY)

同じ値を同じレコード1つにまとめることができる。

=> `SELECT item, SUM(price) FROM tables GROUP BY item;`

=> WHERE句と併用して使用するときは、WHERE句を先に指定すること

## HAVING句

グループ化した後のテーブルに対して条件式を指定する。

=> `SELECT item, SUM(price) FROM tables GROUP BY item HAVING SUM(price) >= 5000;`

## 並び替え(ORDER BY)

=> `ORDER BY 列名 並べ方`

=> デフォルトはASC(昇順)・DESCを指定すると降順になる

## 列名に別名をつける(AS)

列名の後ろにAS句を指定すると、列名に別名をつけることができる。

=> `SELECT item AS '商品名', SUM(price) AS '合計金額' FROM ...;`

## ビュー

実際にデータベースに保存されているテーブルのことを`実表`または`基底表`という。

それに対し、仮想的に作成された表のことを`ビュー`または`導出表`という。

ビューを使用することによって、実際のデータから見せたくないデータを隠すことができる。

ビューと実表は相互に関連付けられているため、どちらかを変更するともう片方も変更される。

=> 複数の表を組み合わせて作られた複雑なビューに対して、データは変更することはできない

### ビューの作り方

`CREATE VIEW ビュー名 AS SELECT 列名 FROM 表名`

```
CREATE VIEW dogs AS SELECT * FROM animals WHERE type = 'dog';
```

## インデックス

データベース検索を高速化する機能。

本の索引と同じように、1つの列と、レコード位置を指し示すポインタから構成される。

レコードが更新されるたびにインデックスを更新する必要があるため、インデックスを増やし過ぎるとデータベース全体の処理効率は悪化する。

## ストアドプロシージャ

データベースに対する複数の命令を1つの命令にまとめて、データベース管理システムに保存したもの。

通常は、命令の数だけデータベースにアクセスする必要がある。

ストアドプロシージャは、データベース管理システムに保存されているストアドプロシージャを呼び出すだけで複数の命令を処理することができる。

=> クライアントとサーバー間のネットワークの負荷を軽減できる

