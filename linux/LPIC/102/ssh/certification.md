# ホスト認証

SSHで接続する際に、このサーバーって本当に信頼できる相手(正しいホスト？)と確認する仕組みのこと。

悪意のある奴が偽サーバーを用意したら、パスワードや秘密情報を盗まれる可能性がる。

=> 最初に(ユーザー名とパスワードの認証に先だって)接続先のホストの身元を確認する

### 鍵と認証の流れ(最初の接続)

- 1 : SSHクライアントがサーバーに接続
- 2 : サーバー側が、これが私の公開鍵ですと提示
- 3 : クライアント側が、その鍵を`~/.ssh/known_hosts`に記録(初回のみ)
- 4 : 次回以降はその記録と照会し一致すれば、いつものサーバーだねと認証完了

このように、ホスト認証は偽ホスト(偽サーバー)へ接続してしまうことを防止する。

ホストの公開鍵は`~/.ssh/known_hosts`に格納される。

# 公開鍵認証

パスワードを使用せず、安全にSSHログインするための仕組み。

- 秘密鍵(private key) : 自分だけが持っている
- 公開鍵(public key) : サーバーに登録する

=> このペアを使って本人確認(認証)をするのが公開鍵認証

### 仕組みの流れ

- 1 : クライアントが鍵ペア(公開鍵と秘密鍵)を作る(`ssh-keygen`コマンド)
- 2 : 公開鍵をサーバーに登録(`~/.ssh/authorized_keys`)
- 3 : SSHで接続するとき、クライアントが秘密鍵を使ってサイン
- 4 : サーバーは公開鍵で検証し、正しい鍵だねと確認してログイン成功

## ssh-keygen

公開鍵と秘密鍵の鍵ペアを作成するコマンド。

- -t : 暗号化タイプを指定(rsa1, rsa, dsa, ecdsa, ed25519)
- -p : パスフレーズを変更
- -f : 鍵ファイルを指定
- -R : 指定されたホストの鍵を`known_hosts`ファイルから削除
- -b : 鍵の長さをビット長で指定(2048など)

パスフレーズは、秘密鍵を利用する際の認証用文字列。

=> 長ければ長い程、セキュリティ面の強度は向上

## 作成されるファイル名

`~/.ssh`ディレクトリに作成される。

| バージョン           | 秘密鍵     | 公開鍵         |
|----------------------|------------|----------------|
| バージョン1          | identity   | identity.pub   |
| バージョン2(DSA)     | id_dsa     | id_dsa.pub     |
| バージョン2(RSA)     | id_rsa     | id_rsa.pub     |
| バージョン2(ECDSA)   | id_ecdsa   | id_ecdsa.pub   |
| バージョン2(ED25519) | id_ed25519 | id_ed25519.pub |

## 公開鍵のサーバー登録

`scp`や`ssh-copy-id`コマンドを使用して、作成した公開鍵をサーバーの`~/.ssh/authorized_key`ファイルに追加する。

`~/.ssh/authorized_key`は所有者のみが読み書きをできるようにしておく(パーミッション値: 600や700)

---

# key

| 鍵の名前                                   | 用途                    | 所有者                | 保存先      | 使われるタイミング                       |
|--------------------------------------------|-------------------------|-----------------------|-------------|------------------------------------------|
| `id_rsa`, `id_rsa.pub`                     | ユーザーの鍵            | SSHクライアント(自分) | `~/.ssh/`   | 自分がサーバーへ接続するとき             |
| `ssh_host_rsa_key`, `ssh_host_rsa_key.pub` | サーバーの鍵(ホスト鍵)  | SSHサーバー側         | `/etc/ssh/` | サーバーが自分を証明するとき(ホスト認証) |

### ユーザーの鍵(id_rsa, id_rsa.pubなど)

- 誰が接続してくるか確認するための鍵
- 自分で作成する : `ssh-keygen`
- 公開鍵はSSH接続するサーバーへ登録 : サーバーの`~/.ssh/authorized_key`へ
- 秘密鍵は絶対外に漏らさない

### サーバーの鍵(ホスト鍵)

- これが本物のサーバーか？を証明するための鍵
- サーバー構築時(OpenSSHインストール時)に自動生成
- クライアントはサーバーに初めて接続したときにこの公開鍵を受け取って、自信の`~/.ssh/known_hosts`に記録

### ファイルの場所

| ファイル                        | 説明                   | 例                 |
|---------------------------------|------------------------|--------------------|
| `~/.ssh/id_rsa`                 | ユーザーの秘密鍵       | クライアント側     |
| `~/.ssh/id_rsa.pub`             | ユーザーの公開鍵       | サーバーに渡す     |
| `/etc/ssh/ssh_host_rsa_key`     | サーバーの秘密ホスト鍵 | サーバーが持つ     |
| `/etc/ssh/ssh_host_rsa_key.pub` | サーバーの公開ホスト鍵 | クライアントが知る |

