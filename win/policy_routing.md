# ポリシールーティング

正式にはポリシーベースルーティング(PBR : Policy Based Routing)

## そのそのの通常ルーティングとは？

宛先IPアドレスに基づいてルーティングテーブルから経路を選ぶ。

宛先が`192.168.1.0/24`はeth1から出すよ、宛先が`10.0.0.0/8`のときはeht2から出すよ～みたいなの。

## ポリシールーティングとは？

送信元IPアドレスやポート番号、プロトコルなど、宛先以外の情報でもルーティング経路を変えることができる方法。

- 特定のIPアドレスからのアクセスは特定の回線を経由させる
- 特定のアプリケーションの通信は優先的に高速回線に流す

などなどいろいろな細かい経路設定を行うことができる。

あるネットワークへの通信に対して、FTP通信の転送経路と、FTP通信以外のすべてのデータの転送経路と2つで経路を分けることで通信通路の負荷の分散なども可能。

---

## Linuxで設定する一例(あくまで参考程度に)

### Step1 : iptables でマークを付ける(FTP通信に)

```
iptables -t mangle -A PREROUTING -s 192.168.1.100 -p tcp --dport 21 -j MARK --set-mark 21
```

`192.168.1.100`から出ていくポート21(FTP)の通信に`21`というマークを付ける。

### Step2 : そのマークに対応するルールを作る

```
ip rule add fwmark 21 table 101
```

`fwmark 21`(iptablesで付けたマーク)に対してルーティングテーブル101を使えと指示。

### Step3 : ルーティングテーブル101に経路を追加

```
ip route add default via 192.168.99.1 dev eth1 table 101
```

FPT通信だけはeth1を使って192.168.99.1にルーティングという意味になる。

### 結果

- 192.168.1.100のFTP通信(ポート21)だけはeth1から出る
- その他の通信は通常のルーティングテーブルに従ってeth0などから出る

### 注意点

- iptablesのマーク : mangleテーブルでMARKを付ける必要がある
- FTPの特性 : 実際のFTPはポート21で制御 + 20やPASVでデータ転送があるので注意
- ポート範囲 : 必要に応じてPASVモードのポート範囲も対象に含めるべき場合あり
- ip ruleの順序 : ip ruleの順番によっては処理がされないことも(優先度を意識)

