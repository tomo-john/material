# ファイルシステムのマウントとアンマウント

ディスク上のファイルシステムを利用するためには、最初にマウントを行う必要あり

## 1 マウントの仕組み

あるファイルシステムに別のファイルシステムを組み込んで、

全体として1つのファイルとして扱えるようにすることを`マウント`という

マウントしたファイルシステムが結合されるディレクトリが`マウントポイント`

`/media`以下や、`/mnt`以下にある空のディレクトリがマウントポイントとして用意されている

マウントはDVD-ROM、USB、NFS(Network File System)にも仕様される

マウントした後はデバイスやネットワークの違いを意識せずにファイルにアクセスできる

- 例: `/media/dvdrom`をマウントポイントとしてDVD-ROM(`/data`)をマウントする

  => DVD内の`/data`は`/media/dvdrom/data`としてアクセスできる

## 2 /etc/fstabファイル

ファイルシステムの情報は`/etc/fstab`ファイルに記述されている

マウントするときはにはこの設定ファイルが参照されるため、マウントする頻度の高いファイルシステムを記述しておく

```
# /etc/fstab
/dev/sda1  /boot  ext3  defaults  1  2
```

- `/dev/sda1`: デバイスファイル名

  => デバイスファイル名もしくはラベル名(`LABEL=ラベル名`)、またはUUIDを指定する

- `/boot`: マウントポイント

  => ファイルシステムのマウント先となるディレクトリを指定

- `ext3`: ファイルシステムの種類

  => ファイルシステムの種類を指定

- `defaults`: マウントオプション

  => マウントする際に必要となるオプションを指定、複数指定の場合は`.`で区切る

- `1`: dumpフラグ

  => 1であれば`dump`コマンドでのバックアップ対象

  => 通常、ext2, ext3は`1`、それ以外のファイルシステムは`0`

- `2`: ブート時にfsckがチェックする順序

  => Linuxが起動するときにfsckがチェックする順序を`0, 1, 2, ...`で指定

  => 0はチェックされず、1から順番にチェック(ルートファイルシステムは1である必要あり)

最近のシステムでは、デバイスファイル欄にUUIDを指定していることがある

### UUID

UUID(Universally Unique Identifier)はデバイスを識別するために使われるID

デバイスにはユニークなUUIDが付けられており、`blkid`コマンドでデバイスファイルとの対応を確認できる

システムにデバイスを追加すると、システム起動時の認識順序が変わることがあり、

その結果、同じデバイスに割り当てられるデバイスファイル名が異なってしまうことがある

それによってシステムの起動時やデバイスへのアクセス時にエラーが発生するおそれがある

=> UUIDでデバイスを指定することによって、そのような事故を防ぐことができる

### 主なマウントオプション

| オプション | 説明                                                                      |
|------------|---------------------------------------------------------------------------|
| async      |ファイルシステムの非同期入出力を設定する                                   |
| auto       |-aオプションでmountコマンドを実行したときにマウントする                    |
| noauto     |-aオプションでmountコマンドを実行してもマウントされない                    |
| defaults   |デフォルトのオプションを設定する(async, auto, dev, exec, nouser, rw, suid) |
| exec       |バイナリの実行を許可する                                                   |
| noexec     |バイナリの実行を許可しない                                                 |
| ro         |読み取り専用でマウントする                                                 |
| rw         |読み書きを許可してマウントする                                             |
| unhide     |隠しファイルも表示する                                                     |
| suid       |SUIDとSGIDを有効にする                                                     |
| user       |一般ユーザーでもマウントを可能にする                                       |
| users      |マウントしたユーザー以外のユーザーもアンマウントできるようにする           |
| nouser     |一般ユーザーのマウントを許可しないようにする                               |

## 3 マウントとアンマウント

### mountコマンド

ファイルシステムをマウントするには`mount`コマンドを使う

オプションなしでmountコマンドを使用すると、現在のマウント状況が表示される

```
mount [オプション]

mount [オプション] デバイス名 マウントポイント
```

- `-a`: /etc/fstabに記述されているファイルシステムをすべてマウント(noautoオプション付きは除く)
- `-t`: ファイルシステムの種類を指定
- `-o`: マウントオプションを指定

/dev/sdb3にあるext4ファイルシステムを/dataディレクトリにマウント

```
mount -t ext4 /dev/sdb3 /data
```

デバイス名もしくはマウントポイントのどちらかを省略すると、/etc/fstabファイルの記述が参照される

### umountコマンド

ファイルシステムをアンマウントするには`umount`コマンドを使う

```
umount [オプション]

umount [オプション] デバイス名 マウントポイント
```

- `-a`: /etc/mtabに記述されているファイルシステムをすべてアンマウントする
- `-t`: 指定した種類のファイルシステムだけをアンマウントする

/dataにマウントした/dev/sdb3パーティションをアンマウント

```
# どちらのコマンドでもOK
umount /data
umount /dev/sdb3
```

マウントしているすべてのxfsファイルをアンマウント

```
umount -at xfs
```

マウントポイント以下のディレクトリを利用中のユーザーやプログラムがある場合、アンマウントはできない

`/etc/mtab`ファイルには、マウントされているファイルシステムの情報が格納されている

`/etc/mtab`ファイルはmount, umountコマンドが使用しているファイルで手動で書き換えはできない

