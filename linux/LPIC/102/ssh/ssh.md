# SSH

SSH(Secure Shell)はリモートホスト間の通信において高いセキュリティを実現するもの。

通信経路のデータが暗号化され、認証にも公開鍵が使われたりと安全性が高い。

=> Telnetは通信内容がプレーンテキスト(平分)で認証もパスワードのみ

SSHにはバージョン1系とバージョン2系があり、`公開鍵暗号方式`の認証アルゴリズムに違いがある。

- SSH-1(バージョン1系) : `RSA1` => 暗号化技術が古い・非推奨
- SSH-2(バージョン2系) : `DSA`・`RSA` => 今はこっち

Linuxでは`OpenSSH`が一般的に利用されており、それぞれのバージョン(のプロトコル)に対応している。

OpenSSHをインストールすると、ホストの公開鍵と秘密鍵が作成され、これらのファイルはホスト認証に使用される。

=> `秘密鍵は絶対に外部に漏らさないように管理する`

### 鍵の種類

| 鍵の種類 | SSHバージョン | 現在の評価         | 特徴・補足                                    |
|----------|---------------|--------------------|-----------------------------------------------|
| RSA1     | SSH-1のみ     | 廃止               | 古いRSA。SSH-2では使えない。非推奨            |
| DSA      | SSH-2         | 推奨されない       | 古い。2048bit以上にできず、セキュリティが弱い |
| RSA      | SSH-2         | 現在も使われている | 一般的な公開鍵暗号。鍵長2048bit以上が推奨     |
| ECDSA    | SSH-2         | 高速で安全         | 楕円曲線暗号を使用。軽量かつ高セキュリティ    |
| ED25519  | SSH-2         | 最も安全・推奨     | 高速・高安全。新しい環境ではこれが推奨される  |

### ホストの公開鍵と秘密鍵

| ファイル名           | 説明                  |
|----------------------|-----------------------|
| ssh_host_key         | 秘密鍵(ver1)          |
| ssh_host_dsa_key     | 秘密鍵(ver2・DSA)     |
| ssh_host_rsa_key     | 秘密鍵(ver2・RSA)     |
| ssh_host_ecdsa_key   | 秘密鍵(ver2・ECDSA)   |
| ssh_host_ed25519_key | 秘密鍵(ver2・ED25519) |

| ファイル名               | 説明                  |
|--------------------------|-----------------------|
| ssh_host_key.pub         | 公開鍵(ver1)          |
| ssh_host_dsa_key.pub     | 公開鍵(ver2・DSA)     |
| ssh_host_rsa_key.pub     | 公開鍵(ver2・RSA)     |
| ssh_host_ecdsa_key.pub   | 公開鍵(ver2・ECDSA)   |
| ssh_host_ed25519_key.pub | 公開鍵(ver2・ED25519) |

# sshd (/etc/ssh/sshd/config)

SSHサーバーの機能は`sshdデーモン`が提供する。

=> 設定ファイルは`/etc/ssh/sshd_config`

| 設定項目               | 説明                                     |
|------------------------|------------------------------------------|
| Port                   | SSHで使用するポート番号(デフォルトは22)  |
| Protocol               | SSHのバージョン(1と2)                    |
| HostKey                | ホストの秘密鍵ファイル                   |
| PermitRootLogin        | rootでもログインを許可するかどうか       |
| PSAAuthentication      | SSHバージョン1での公開鍵認証を使用するか |
| PubkeyAuthentication   | SSHバージョン2での公開鍵認証を使用するか |
| AuthorizedKeysFile     | 公開鍵が格納されるファイル名             |
| PermitEmptyPasswords   | 空のパスワードを許可するか               |
| PasswordAuthentication | パスワード認証を許可するか               |
| X11Forwarding          | X11転送を許可するか                      |

# sshコマンド

SSHを使用してリモートホストにログインするためのコマンド。

`ssh [[ログインユーザー名@]ホスト]`

- -p : ポート番号を使用
- -l : 接続するユーザーを指定
- -i : 秘密鍵ファイルを指定
- -o : ssh_configで設定できるオプションを指定する

```
# 192.168.1.100のマシンにユーザーjohnでログイン
tomo$ ssh john@192.168.1.100

# ユーザー名を省略すると、現在ログイン中のローカルユーザー名(自分の端末のユーザー名)がそのまま使用される(この場合tomo)
tomo$ ssh 192.168.1.100

# -lは明示的にログインユーザー名を指定(シェルスクリプトとかで使用される) ssh john@192.168.1.100と同じ
tomo$ ssh -l john 192.168.1.100
```

### sshコマンドの動作

sshコマンドは、以下の順で取得した設定に基づいて動作する。

- 1. コマンドラインオプション
- 2. ユーザーごとの設定ファイル(`~/.ssh/config`)
- 3. システム全体の設定ファイル(`/etc/ssh/ssh_config`)

### -oオプションでの指定

- 秘密鍵(`-i`) : `-o IdentityFile=`
- ログインユーザー名(`-l`) : `-o User=`
- 接続先ポート(`-p`) : `-o Port=`

---

# ssh-agent

SSHの秘密鍵を一時的にメモリに保持してくれる便利な仕組み。

鍵のパスフレーズを毎回入力する手間を減らしてくれる。

ssh-agentはクライアント側で稼働するデーモンで、SSHの秘密鍵を安全に保持してくれる`鍵マネージャ`。

### 基本的な使い方

- ssh-agentの子プロセスとしてbashを起動 : `ssh-agent bash`
- `ssh-add`コマンドで秘密鍵を登録 : このときパスフレーズを聞かれる
- `ssh-add -l`で登録された鍵の一覧表示

=> 起動した子プロセスのbashシェルならびその子プロセスではパスフレーズの入力が不要になる

---

# ポート転送

SSHポート転送(ポートフォワーディング)とは、あるポートに送られてきたTCPパケットを、SSHを使った安全な通信路を経由して、リモートホストの任意のポートに転送すること。

=> POP3やFTPなどの暗号化されていないプロトコルを使った通信の安全性を高めることができる

```
ssh -f -N -L 10110:john.example.net:110 john@john.example.net
```

- ローカルの10110番ポートに接続すると、リモートホストの110番ポートに接続
- SSHで`john@example.net`にログイン
- -f : バックグラウンドで実行
- -N : 転送のみを指示
- -L : ローカルポートフォワーディングの設定(`-L [ローカルポート]:[転送先ホスト]:[転送先ポート]`)

---

# X11フォワーディング/X11転送(-X)

SSHのポートフォワーディング機能を使って、ネットワークを介したXサーバー・クライアントの通信を暗号化し、接続を簡略化することができる。

=> XフォワーディングもしくはX11転送

`ssh -X`はXフォワーディングを有効にするためのオプション。

```
# クライアント側で実行
ssh -X john@192.168.1.100
```

- SSHサーバー(192.168.1.100)上のXクライアントが、SSHクライアント(コマンドを実行したホスト側)のXサーバー画面上に表示される。
- `-X`をつけてssh接続すると、Xクライアント表示用のDISPLAY環境変数が自動で設定される

### 前提条件

- ローカル側 : Xサーバーが動作している必要あり
- SSHクライアント側 : sshの`-X`を使う
- SSHサーバー側 : `/etc/ssh/sshd_config`に`X11Forwarding yes`が設定されている必要あり

---

# SSHに関する主なファイル

| 種類         | SSHクライアント     | SSHサーバー(sshd)             |
|--------------|---------------------|-------------------------------|
| 設定ファイル | /etc/ssh/ssh_config | /etc/ssh/sshd_config          |
| 秘密鍵       | ~/.ssh/id_rsa       | /etc/ssh/ssh_host_rsa_key     |
| 公開鍵       | ~/.ssh/id_rsa.pub   | /etc/ssh/ssh_host_rsa_key.pub |
| 鍵認証リスト | ~/.ssh/known_hosts  | ~/.ssh/authorized_keys        |

### ホスト認証

- クライアントの`~/.ssh/known_hosts`にサーバーの`/etc/ssh/ssh_host_rsa_key.pub`を登録

### ユーザー認証時

- サーバーの`~/.ssh/authorized_keys`にクライアントの`~/.ssh/id_rsa.pub`を登録

