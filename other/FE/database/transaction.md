# トランザクション

データベースに対する一連の処理を、分割できない1つの単位(論理的な単位)として扱う仕組み。

データベースのデータが処理の途中で矛盾した状態になることを防ぐ。

トランザクション内の処理はすべて成功するか、すべて失敗するかのどちらか。

=> これを原子性(Atomicity)と呼び、ACID特性の1つ

複数の処理が組み合わさっていても、全体として1つの処理とみなされる。

## コミット(Commit)

トランザクションに含まれるすべての一連の処理を確定し、データベースへの変更を永続化(確定)させるための命令。

トランザクションの終わりにコミットが実行されると、そのトランザクションで行われたすべての変更がデータベースに正式に反映。

=> 元に戻せない状態になる(永続性)

コミットされるまでの間は、もし何かしらのエラーや障害が発生した場合、データベースはトランザクション開始前の状態にロールバックが可能。

## ロールバック(Rollback)

コミットと対になるのがロールバック。

トランザクションが途中で失敗したり、ユーザーが操作を取り消したりした場合に、トランザクション開始前の状態にデータベースを戻すための命令。

## 2相コミット

Two Phase Commit

トランザクションのコミットを次の2つの段階に分けて行うことで、分散データベース環境での原子性・一貫性を保証する仕組み。

- 第1フェーズ: 他サイトに更新可能かどうかを確認する。
- 第2フェーズ: 全サイトからの合意が得られた場合に更新を確定する。

コミットの調整を行う1つのノードを`調停者(主サイト)`、ネットワーク上の他のノードを`参加者(従サイト)`として以下の手順を実施。

### 第1相(投票層)

- 1. 主サイトはネットワーク上の全ての従サイトにコミットの可否を問合せ
- 2. 全ての従サイトは主サイトにコミットの可否を応答

### 第2相(決定層)

- 3. 全ての従サイトから合意 => 全ての従サイトにコミットの実行要求を発光

  => コミット停止の従サイトあり or タイムアウト => 全ての従サイトにロールバック要求

- 4. 全ての従サイトはコミット(またはロールバック)の完了とともに主サイトに処理完了メッセージ送る
- 5. 主サイトが全ての従サイトからの処理完了メッセージを受け取り、トランザクションの完了

