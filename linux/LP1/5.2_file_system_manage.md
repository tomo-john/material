# ファイルシステムの管理

## 1 ディスクの利用状況確認

システムの運用にあたって、ファイルシステムの管理は重要

ファイルシステムの空き領域がなくなったり破壊された場合、すみやかに復旧が必要となる

- 空き容量が不足している
- 使用できるiノードがない

=> これらはファイルシステムに書き込みができなくなる要因の一例

ファイルシステムの空き容量は`df`コマンドで確認することが可能

```
df [オプション] [デバイス名やディスク名]
```

- `-h`: 1024バイト基準で読みやすい単位に換算(M=1,048,576バイト)
- `-H`: 1000バイト基準で読みやすい単位に換算(M=1,000,000バイト)
- `-k`: KB単位で表示
- `-i`: iノードの使用状況を表示

引数なしで使用すると、マウントされているすべてのファイルシステムの使用状況を表示

ディレクトを指定すると、そのディレクトが属しているファイルシステムのみを表示

iノードには、ディスク上のファイルに関する情報(アクセス権、所有者など)が記録されている

=> すべてのファイルには対応するiノードが存在する

作成できるiノードの数はファイルシステム作成時に設定され、後から追加や変更は不可

=> iノードが枯渇すると、ディスクに空きがあってもファイルの新規保存ができない

=> 小さいサイズのファイルを大量に保存する場合はiノード不足に注意

ファイルやディレクトリが占めている容量を表示するには`du`コマンドを使用する

```
du [オプション] [ファイル名やディレクトリ名]
```

=> 引数のファイル名やディレクトリ名を省略するとカレントディレクトリを対象とする

- `-a`: ディレクトリ以外にファイルについても表示
- `-l`: リンクも含めて集計
- `-c`: すべての容量の合計を表示
- `-s`: 指定したファイルやディレクトリのみの合計を表示
- `-S`: サブディレクトリを含めず集計

## 2 ファイルシステムのチェック

`fsck`コマンドを使用することで、ディスクのチェックを行い、必要であれば修復を試みることが可能

ディスクのチェックと修復は、ファイルシステムをアンマウントした状態で行う

=> 書き込み中のディスクに対して実行すると、ファイルシステムを破壊する可能性があるので注意

=> アンマウントか少なくとも読み取り専用モードでマウントしておく

`fsck`は実際にはファイルシステムごとに用意されたチェックプログラム(`fsck.ext3`や`fsck.xfs`)のフロントエンド

```
fsck [オプション] [デバイス名]
```

- `-t ファイルシステム名`: ファイルシステムの種類を指定
- `-a`: 自動的に修復を実行
- `-r`: 対話的に修復を実行
- `-A`: /etc/fstabに記述されている全ファイルシステムに対して実行
- `-N`: 実際には実行せずに何が行われるのかを表示

ext2, ext3, ext4ファイルシステムのチェック修復には、`e2fsck`コマンドを利用することが可能

```
e2fsck [オプション] デバイス名
```

- `-p`: すべての不良ブロックを自動的に修復
- `-y`: 問い合わせに対して自動的に「yes」と回答
- `-n`: 問い合わせに対して自動的に「no」と回答

