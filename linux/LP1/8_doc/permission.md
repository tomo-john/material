# permission

パーミッションとは、フィアルやディレクトリへのアクセス権限を指す。

`読み取り権`、`書き込み権`、`実行権`の3種類がある。

| 権限 | ファイルに適用した場合             | ディレクトリに適用した場合                                                        |
|------|------------------------------------|-----------------------------------------------------------------------------------|
| 読み | ファイルの内容を参照(cat,lessなど) | ディレクトリの内容を参照(ls,findなど)                                             |
| 書き | ファイルに書き込み(vimなど)        | ディレクトリ内に新規ファイルの作成、既存フィアルの名前変更や削除(touch,mv,rmなど) |
| 実行 | ファイルを実行(スクリプトなど)     | ディレクトリ内のファイルへのアクセス、ディレクトリへ移動(cd)                      |

これらの権限がユーザーのカテゴリごと(所有ユーザー、所有グループ、その他ユーザーの3種)に設定される。

## 基本項目

### パーミッション値  

- 4: 読み取り
- 2: 書き込み
- 1: 実行

### 対象

- u: 所有者
- g: 所有グループ
- o: その他ユーザー
- a: 全てのユーザー

### 操作

- +: 権限を追加
- -: 権限を削除
- =: 権限を設定

### 権限

- r: 読み取り権
- w: 書き込み権
- w: 実行権
- s: SUIDまたはSGID
- t: スティッキービット

```
# ユーザーは読み書き、所有グループは読み取りのみ、その他ユーザーは読み取りのみ
chmod 644 file
chmod u=rw,go=r file
```

## umask

システムのパーミッション初期値は、新規ファイルは`666`、新規ディレクトリは`777`。

umask値はパーミッション初期値からどの権限を削除するかを定義する設定。

一番左に0を付加した4桁の数字での指定が可能。

指定した数値の権限がパーミッション初期値から削除される。(例: 2なら書き込み権のみ、3なら書き込み権と実行が削除)

=> 単純な引き算ではないので注意

umask値が`0022`の場合、新規ファイルは`644`、新規ディレクトリは`755`となる。

umask値が`0037`の場合、新規ファイルは`640`、新規ディレクトリは`740`となる。

umaskコマンドを引数なしで実行すると現在のumask値の確認が可能。

引数にumask値を設定することで、そのシェル上でのみumask値を新たな値に変更できる。

## 特殊なパーミッション

通常のパーミッションに特殊な操作制御を加えるためのパーミッションとして、`SUID`, `SGID`, `スティッキービット`の3種類が存在する。

通常のパーミッション値は3桁の数値だが、これらの特殊パーミッションが設定されている場合、それを示す1桁を左に追加し、合計4桁の数値が用いられる。

4桁の数値:

- 4000: SUID
- 2000: SGID
- 1000: スティッキービット

## SUID (Set User ID)

実行ファイルに設定することで、そのプログラムをどのユーザーが実行しても、プログラムの所有ユーザーの権限で実行される。

設定方法:

- 通常のパーミッション値に`4000`を加えた数値を設定
- 所有ユーザーに`s`の権限を追加(u+s)

SUIDが設定されると、パーミッションの所有ユーザーの実行権の箇所が`s`と表示される。

```
# ls -l /bin/passwd
-rwsr-xr-x 1 root root 59976 Feb  6  2024 /bin/passwd
```

## SGID (Set Group ID)

実行ファイルに設定することで、そのプログラムをどのユーザーが実行しても、プログラムの所有グループの権限で実行される。

ディレクトリに設定することで、そのディレクトリ配下に作成したファイルやディレクトリの所有グループは親ディレクトリと同じになる。

設定方法:

- 通常のパーミッション値に`2000`を加えた数値を設定
- 所有グループに`s`の権限を追加(g+s)

SGIDが設定されると、パーミッションの所有グループの実行権の箇所が`s`と表示される。

## スティッキービット

ディレクトリに設定することで、そのディレクトリに対して書き込み権限を持つユーザーでも自分が所有していないファイルの削除を禁止する。

=> ファイル所有者(とroot)しかファイルを削除することができない

=> `/tmp`などいろんなユーザーが利用するディレクトリなどに設定される。

設定方法:

- 通常のパーミッション値に`1000`を加えた数値を設定
- その他ユーザーに`t`という権限を追加(o+t)

スティッキービットが設定されると、パーミッションのその他ユーザーの実行権の箇所が`t`と表示される。

```
# ls -ld /tmp
drwxrwxrwt 11 root root 4096 Jan 10 09:39 /tmp
```

---

# permission関連コマンド

## ls -l

ファイルやディレクトリの詳細情報を表示する。その際に設定されているパーミッションも表示される。

```
# ls -lの出力例
-rwxr-xr-x 1 john dog 1234 Jan 21 10:00 file.txt
```

一番左の記号はファイル(`-`)かディレクトリ(`d`)かシンボリックリンク(`l`)を表す。

残り9つの記号が権限を表す。 => 所有者権限、グループ権限、その他ユーザー権限(上記の例なら、file.txtの権限は755)

## chmod

ファイルやディレクトリの権限を変更する。

### 方式1: シンボリックモード

権限を追加・削除・変更する。

`chmod [誰に][+/-/=][権限] ファイル(orディレクトリ)`

- 誰に:
  - u: 所有者(user)
  - g: グループ(group
  - o: その他ユーザー(others)
  - a: 全員(all)

- 権限: r, w, xを指定

```
# 全員に実行権を付与
chmod a+x file

# その他ユーザーから書き込み権限を削除
chmod o-w file
```

`=`を使用する場合、指定した権限を設定し、既存の権限はリセットされる。(=で指定した権限以外はリセットされる)

```
# 所有者に読み書き、グループに読み、その他ユーザーは権限なし(rw-r-----, 640)
chmod u=rw,g=r,o= file
```

### 方式2: 数字モード

権限を数字で指定。

| 数字 | 権限 |
|------|------|
| 0    | ---  |
| 1    | --x  |
| 2    | -w-  |
| 3    | -wx  |
| 4    | r--  |
| 5    | r-x  |
| 6    | rw-  |
| 7    | rwx  |

```
# 権限を rwxr-xr-- に設定
chmod 754 file
```

### オプション

- -R: ディレクトリ内のすべてのファイルとサブディレクトリの権限を一括変更

# chown

ファイルの所有者またはグループを変更する。

```
chown [新しい所有者]:[新しいグループ] ファイル名
```

`:`は`,`でも代用できるが、一部環境では使用できない場合もあるので、基本的に`:`を使用する。


```
# 所有者をjohn、所有グループをdogsに変更
chown john:dogs file
```

### 所有者のみ、所有グループのみの変更も可能

```
# 所有者のみjohnに変更
chown john file

# 所有グループのみdogsに変更
chown :dogs file

# 所有グループのみdogsに変更(非推奨)
chown ,dogs file
```

### オプション

- -R: ディレクトリ内のファイルとサブディレクトリの所有者と所有グループを伊勝変更

